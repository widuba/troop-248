<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Merit Badge — Troop 248</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/bsafavicon.ico">

  <style>
    :root {
      --red: #b22222;
      --blue: #1f4e79;
      --tan: #f4eee3;
      --white: #ffffff;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --radius-lg: 16px;
      --radius-pill: 999px;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.06);
      --ok: #166534;
      --warn: #92400e;
      --bad: #991b1b;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:#d2cab6; color:var(--text-main); min-height:100vh; }
    header {
      background: linear-gradient(120deg, #b22222, #ffffff, #1f4e79);
      color: var(--white);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h2 { margin:0; font-size:19px; letter-spacing:0.08em; text-transform:uppercase; display:flex; align-items:center; gap:8px; }
    header h2::before { content:"★"; font-size:18px; }
    .troop-home-link { text-decoration:none; color:inherit; display:inline-flex; align-items:center; }
    .troop-home-link:hover h2 { opacity:0.9; text-decoration: underline; }
    nav { display:flex; gap:12px; font-size:13px; text-transform:uppercase; }
    nav a {
      color:#1f4e79; font-weight:bold; text-decoration:none;
      padding:6px 10px; border-radius:var(--radius-pill);
      border:1px solid rgba(255,255,255,0.25);
      backdrop-filter: blur(4px);
      opacity:0.9;
    }
    nav a:hover { opacity:1; background: rgba(255,255,255,0.12); }

    #auth-bar { display:flex; gap:10px; align-items:center; font-size:13px; }
    .auth-btn {
      padding: 5px 12px;
      font-size: 13px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.7);
      background: rgba(255, 255, 255, 0.1);
      color: var(--white);
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
    }
    .auth-btn:hover { background: rgba(255, 255, 255, 0.2); }

    main { padding:24px 16px 40px; max-width:960px; margin:0 auto; }

    .welcome-card {
      background: rgba(255,255,255,0.95);
      border-radius: var(--radius-lg);
      padding: 18px 18px 8px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-soft);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:16px;
      border: 1px solid rgba(148,163,184,0.4);
    }
    .welcome-card h3 { margin:0 0 4px; font-size:18px; }
    .welcome-card p { margin:0; font-size:14px; color: var(--text-muted); }

    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: var(--radius-pill);
      background: rgba(148, 163, 184, 0.2);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.07em;
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }
    .badge.admin {
      background: rgba(240, 180, 41, 0.16);
      color: #92400e;
      border: 1px solid rgba(245, 158, 11, 0.6);
    }

    section {
      background: rgba(255,255,255,0.95);
      border-radius: var(--radius-lg);
      padding: 18px 18px 14px;
      margin-bottom: 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148,163,184,0.4);
    }
    section h2 { margin-top:0; font-size:18px; display:flex; align-items:center; gap:8px; }
    section h2::before { content:"▸"; font-size:14px; color: var(--blue); }
    .small-help { font-size:12px; color: var(--text-muted); margin-top:6px; line-height: 1.35; }

    .error {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(185, 28, 28, 0.35);
      background: rgba(185, 28, 28, 0.08);
      color: #991b1b;
      display: none;
      font-size: 13px;
    }
    .error.show { display:block; }

    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .select {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 14px;
      min-width: 260px;
    }

    .req {
      border-radius: 14px;
      border: 1px solid rgba(31,78,121,0.18);
      background: rgba(31,78,121,0.06);
      padding: 12px;
      margin-top: 10px;
    }
    .req-top { display:flex; gap:10px; justify-content:space-between; align-items:flex-start; }
    .req-text { font-size: 14px; line-height: 1.35; }
    .status-pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(255,255,255,0.65);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      white-space: nowrap;
      height: fit-content;
    }
    .status-pill.requested { border-color: rgba(245,158,11,0.6); color: var(--warn); background: rgba(245,158,11,0.10); }
    .status-pill.approved  { border-color: rgba(34,197,94,0.6);  color: var(--ok);   background: rgba(34,197,94,0.10); }
    .status-pill.denied    { border-color: rgba(239,68,68,0.6);   color: var(--bad);  background: rgba(239,68,68,0.10); }

    .btnrow { display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }
    .btn {
      padding: 7px 12px;
      border-radius: var(--radius-pill);
      border: none;
      cursor: pointer;
      font-weight: 650;
      font-size: 13px;
    }
    .btn.primary { background: var(--blue); color: #fff; }
    .btn.approve { background: rgba(34,197,94,0.18); border: 1px solid rgba(34,197,94,0.35); color: #166534; }
    .btn.deny    { background: rgba(239,68,68,0.14); border: 1px solid rgba(239,68,68,0.35); color: #991b1b; }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }
    .meta { margin-top: 6px; font-size: 12px; color: var(--text-muted); }
  </style>

  <link rel="stylesheet" href="/modern-2026.css" />
</head>

<body>
  <header>
    <div><a href="/home" class="troop-home-link"><h2>Troop 248</h2></a></div>
    <nav>
      <a href="/home">Home</a>
      <a href="/calendar">Calendar</a>
      <a href="/documents">Documents</a>
      <a href="/scoutmaster">SM Blog</a>
      <a href="/spl">SPL Blog</a>
      <a href="/useful-links">Useful Links</a>
      <a href="/events">Events</a>
      <a href="/mail">Mail</a>
      <a href="/advancements">Advancements</a>
    </nav>
    <div id="auth-bar">
      <div id="auth-info">Not signed in</div>
      <a id="login-link" class="auth-btn" href="/login/">Log In</a>
      <button id="logout-btn" class="auth-btn" style="display:none;">Log Out</button>
    </div>
  </header>

  <main>
    <div class="welcome-card">
      <div>
        <h3 id="mb-title">Merit Badge</h3>
        <p id="mb-sub" class="small-help">Loading…</p>
      </div>
      <div id="role-badge-container">
        <span class="badge">Guest</span>
      </div>
    </div>

    <section>
      <h2>Who are we viewing?</h2>
      <div class="row">
        <div class="small-help" id="viewerHelp">
          Sign in as a Scout to request completion, or as an Admin to approve/deny for any Scout.
        </div>

        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <select id="scoutSelect" class="select" style="display:none;"></select>
        </div>
      </div>
      <div id="errBox" class="error"></div>
    </section>

    <section>
      <h2>Requirements</h2>
      <div class="small-help">
        Scouts can click “Request completion.” Admins can approve/deny requests.
      </div>

      <div id="reqList"></div>
      <div id="empty" class="small-help" style="display:none;margin-top:10px;">
        No requirements loaded yet. (Add them under meritBadgeCatalog/{slug}/requirements)
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      where,
      orderBy,
      onSnapshot,
      getDocs,
      runTransaction,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD5qUHa2JuQ3iI7U3DrX7JDyhx76PGzhxM",
      authDomain: "troop-248.firebaseapp.com",
      projectId: "troop-248",
      storageBucket: "troop-248.firebasestorage.app",
      messagingSenderId: "925363875752",
      appId: "1:925363875752:web:0b001c1a7a09fb8232f79d",
      measurementId: "G-NY75GX5TBH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---- read slug from /.../merit-badge/{slug} ----
    const parts = location.pathname.split("/").filter(Boolean);
    const slug = parts[parts.length - 1];

    // UI
    const authInfoEl = document.getElementById("auth-info");
    const loginLink = document.getElementById("login-link");
    const logoutBtn = document.getElementById("logout-btn");
    const roleBadgeContainer = document.getElementById("role-badge-container");

    const mbTitle = document.getElementById("mb-title");
    const mbSub = document.getElementById("mb-sub");

    const scoutSelect = document.getElementById("scoutSelect");
    const reqList = document.getElementById("reqList");
    const emptyEl = document.getElementById("empty");
    const errBox = document.getElementById("errBox");

    function showError(msg){
      errBox.textContent = msg;
      errBox.classList.add("show");
    }
    function clearError(){
      errBox.textContent = "";
      errBox.classList.remove("show");
    }

    let currentUser = null;
    let authRole = null;
    let accountType = null;
    let displayName = null;

    let selectedScoutUid = null;

    let unsubReqs = null;
    let unsubProgress = null;

    async function loadBadgeNameFromJson() {
      try{
        const res = await fetch("/advancements/merit-badges/merit-badges.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Could not load merit-badges.json");
        const all = await res.json();
        const found = all.find(x => x.slug === slug);
        if (found) {
          mbTitle.textContent = found.name;
          mbSub.textContent = `Merit badge: ${found.name} • Slug: ${slug}`;
        } else {
          mbTitle.textContent = "Merit Badge";
          mbSub.textContent = `Unknown badge slug: ${slug}`;
        }
      } catch {
        mbTitle.textContent = "Merit Badge";
        mbSub.textContent = `Slug: ${slug}`;
      }
    }

    async function loadAccountInfo(uid){
      const infoRef = doc(db, "accountInfo", uid);
      const infoSnap = await getDoc(infoRef);
      if (!infoSnap.exists()) return { authRole: null, accountType: null, displayName: null };
      const d = infoSnap.data() || {};
      return { authRole: d.authRole || null, accountType: d.accountType || null, displayName: d.displayName || null };
    }

    function setGuestUI(){
      authInfoEl.textContent = "Not signed in";
      roleBadgeContainer.innerHTML = `<span class="badge">Guest</span>`;
      loginLink.style.display = "";
      logoutBtn.style.display = "none";
      scoutSelect.style.display = "none";
      selectedScoutUid = null;
      teardownProgressListener();
      reqList.innerHTML = "";
      emptyEl.style.display = "none";
    }

    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      setGuestUI();
    });

    function isAdmin(){ return authRole === "admin"; }
    function isScoutViewer(){ return accountType === "scout"; }

    async function loadScoutListForAdmin(){
      // Admin can see all scouts via accountInfo where accountType == "scout"
      const qScouts = query(
        collection(db, "accountInfo"),
        where("accountType", "==", "scout")
      );
      const snap = await getDocs(qScouts);
      const scouts = snap.docs.map(d => ({ uid: d.id, ...(d.data() || {}) }));

      // Sort best-effort by displayName/email
      scouts.sort((a,b)=>{
        const an = (a.displayName || a.email || a.uid).toLowerCase();
        const bn = (b.displayName || b.email || b.uid).toLowerCase();
        return an.localeCompare(bn);
      });

      scoutSelect.innerHTML = "";
      for (const s of scouts){
        const opt = document.createElement("option");
        opt.value = s.uid;
        opt.textContent = s.displayName
          ? `${s.displayName} (${s.email || s.uid})`
          : (s.email || s.uid);
        scoutSelect.appendChild(opt);
      }

      if (!selectedScoutUid && scouts.length) selectedScoutUid = scouts[0].uid;
      scoutSelect.value = selectedScoutUid || "";
    }

    function teardownProgressListener(){
      if (unsubProgress) unsubProgress();
      unsubProgress = null;
    }
    function teardownReqListener(){
      if (unsubReqs) unsubReqs();
      unsubReqs = null;
    }

    function listenToRequirements(){
      teardownReqListener();
      const reqsRef = collection(db, "meritBadgeCatalog", slug, "requirements");
      const qReqs = query(reqsRef, orderBy("sort", "asc"));
      unsubReqs = onSnapshot(qReqs, (snapshot)=>{
        const reqs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        if (reqs.length === 0){
          emptyEl.style.display = "block";
          reqList.innerHTML = "";
          return;
        }
        emptyEl.style.display = "none";
        renderRequirements(reqs);
      });
    }

    function listenToProgressForScoutUid(uid){
      teardownProgressListener();

      // Listen to requirement statuses for this scout for this badge.
      const progRef = collection(db, "users", uid, "meritBadges", slug, "requirements");
      unsubProgress = onSnapshot(progRef, (snapshot)=>{
        const map = {};
        for (const d of snapshot.docs){
          map[d.id] = d.data();
        }
        // Attach to DOM by storing on window (simple) and re-render via latest req list
        window.__progressMap = map;
      });
    }

    function statusFromProgress(progress){
      const s = progress?.status;
      if (s === "requested" || s === "approved" || s === "denied") return s;
      return "not_started";
    }

    function renderRequirements(reqs){
      const progressMap = window.__progressMap || {};
      reqList.innerHTML = "";

      const admin = isAdmin();
      const scoutSelf = (!admin && currentUser && isScoutViewer() && selectedScoutUid === currentUser.uid);

      for (const r of reqs){
        const prog = progressMap[r.id] || null;
        const status = statusFromProgress(prog);

        const wrap = document.createElement("div");
        wrap.className = "req";

        const top = document.createElement("div");
        top.className = "req-top";

        const text = document.createElement("div");
        text.className = "req-text";
        text.textContent = r.text || "(no text)";

        const pill = document.createElement("div");
        pill.className = "status-pill" + (status !== "not_started" ? " " + status : "");
        pill.textContent =
          status === "not_started" ? "Not started" :
          status === "requested" ? "Requested" :
          status === "approved" ? "Approved" : "Denied";

        top.appendChild(text);
        top.appendChild(pill);
        wrap.appendChild(top);

        const meta = document.createElement("div");
        meta.className = "meta";
        if (status === "approved" && prog?.decidedByName){
          meta.textContent = `Approved by ${prog.decidedByName}`;
        } else if (status === "denied" && prog?.decidedByName){
          meta.textContent = `Denied by ${prog.decidedByName}`;
        } else if (status === "requested" && prog?.requestedAt){
          meta.textContent = `Requested (awaiting approval)`;
        } else {
          meta.textContent = "";
        }
        wrap.appendChild(meta);

        const btnrow = document.createElement("div");
        btnrow.className = "btnrow";

        // Scout request button (only for their own profile)
        if (scoutSelf){
          const btn = document.createElement("button");
          btn.className = "btn primary";
          btn.textContent = (status === "requested") ? "Requested" :
                            (status === "approved") ? "Approved" :
                            (status === "denied") ? "Request again" : "Request completion";
          btn.disabled = (status === "requested" || status === "approved");
          btn.onclick = () => requestCompletion(selectedScoutUid, r.id);
          btnrow.appendChild(btn);
        }

        // Admin buttons
        if (admin){
          const a = document.createElement("button");
          a.className = "btn approve";
          a.textContent = "Approve";
          a.disabled = (status === "approved");
          a.onclick = () => decideRequirement(selectedScoutUid, r.id, "approved");

          const d = document.createElement("button");
          d.className = "btn deny";
          d.textContent = "Deny";
          d.disabled = (status === "denied");
          d.onclick = () => decideRequirement(selectedScoutUid, r.id, "denied");

          btnrow.appendChild(a);
          btnrow.appendChild(d);
        }

        if (btnrow.children.length) wrap.appendChild(btnrow);
        reqList.appendChild(wrap);
      }
    }

    async function requestCompletion(scoutUid, reqId){
      clearError();
      if (!currentUser) return showError("Please log in.");
      if (scoutUid !== currentUser.uid) return showError("You can only request completion for your own requirements.");
      if (!isScoutViewer()) return showError("Only Scout accounts can request completion.");

      const targetRef = doc(db, "users", scoutUid, "meritBadges", slug, "requirements", reqId);

      try{
        await runTransaction(db, async (tx)=>{
          const snap = await tx.get(targetRef);
          const data = snap.exists() ? (snap.data() || {}) : {};
          const status = data.status || "not_started";
          if (status === "approved") return; // nothing to do
          tx.set(targetRef, {
            status: "requested",
            requestedAt: serverTimestamp(),
            decidedAt: null,
            decidedByUid: null,
            decidedByName: null
          }, { merge: true });
        });
      } catch (e){
        showError(e?.message || "Request failed.");
      }
    }

    async function decideRequirement(scoutUid, reqId, decision){
      clearError();
      if (!currentUser) return showError("Please log in.");
      if (!isAdmin()) return showError("Admins only.");

      const targetRef = doc(db, "users", scoutUid, "meritBadges", slug, "requirements", reqId);

      try{
        await runTransaction(db, async (tx)=>{
          tx.set(targetRef, {
            status: decision,
            decidedAt: serverTimestamp(),
            decidedByUid: currentUser.uid,
            decidedByName: (displayName || currentUser.email || "Admin")
          }, { merge: true });
        });
      } catch (e){
        showError(e?.message || "Decision failed.");
      }
    }

    async function refreshSelectedContext(){
      // Requirements are global per badge; progress is per scout+badge.
      listenToRequirements();

      if (!currentUser){
        selectedScoutUid = null;
        teardownProgressListener();
        reqList.innerHTML = "";
        return;
      }

      if (isAdmin()){
        scoutSelect.style.display = "";
        await loadScoutListForAdmin();

        // listen to selected scout’s progress
        listenToProgressForScoutUid(selectedScoutUid);

        // re-render when selection changes
        scoutSelect.onchange = async ()=>{
          selectedScoutUid = scoutSelect.value;
          listenToProgressForScoutUid(selectedScoutUid);
        };
        return;
      }

      // Non-admin: only scouts can view their own
      scoutSelect.style.display = "none";

      if (isScoutViewer()){
        selectedScoutUid = currentUser.uid;
        listenToProgressForScoutUid(selectedScoutUid);
        return;
      }

      // Parent/leader viewer (non-admin): no access to progress
      selectedScoutUid = null;
      teardownProgressListener();
      reqList.innerHTML = "";
      showError("Advancements are available to Scout profiles only (unless you are an Admin).");
    }

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;

      if (!currentUser){
        setGuestUI();
        await loadBadgeNameFromJson();
        listenToRequirements(); // show reqs list even to guests if you want
        return;
      }

      loginLink.style.display = "none";
      logoutBtn.style.display = "";

      const info = await loadAccountInfo(currentUser.uid);
      authRole = info.authRole;
      accountType = info.accountType;
      displayName = info.displayName || currentUser.displayName || null;

      authInfoEl.textContent = `Signed in as ${currentUser.email}`;

      roleBadgeContainer.innerHTML = `
        <span class="badge ${isAdmin() ? "admin" : ""}">
          ${isAdmin() ? "Admin" : (accountType || "Viewer")}
        </span>
      `;

      await loadBadgeNameFromJson();
      await refreshSelectedContext();
    });

    // init
    loadBadgeNameFromJson();
    listenToRequirements();
    setThemeForLevel(1);
    function setThemeForLevel(level){
      overlay.classList.remove("t1","t2","t3","t4","t5","t6");
      overlay.classList.add("t" + level);
      chestEl.classList.remove("skin1","skin2","skin3","skin4","skin5","skin6");
      chestEl.classList.add("skin" + level);
    }
  </script>
</body>
</html>
