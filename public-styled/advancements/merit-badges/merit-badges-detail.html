<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Merit Badge — Troop 248</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/bsafavicon.ico">
  <link rel="stylesheet" href="/modern-2026.css" />

  <style>
    :root {
      --red:#b22222; --blue:#1f4e79; --white:#fff;
      --text-main:#1f2933; --text-muted:#6b7280;
      --radius-lg:16px; --radius-pill:999px;
      --shadow-soft:0 10px 25px rgba(0,0,0,0.06);
    }
    *{box-sizing:border-box;}
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#d2cab6;color:var(--text-main);min-height:100vh;}
    header{
      background:linear-gradient(120deg,#b22222,#ffffff,#1f4e79);
      color:var(--white);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;
      position:sticky;top:0;z-index:10;
    }
    header h2{margin:0;font-size:19px;letter-spacing:.08em;text-transform:uppercase;display:flex;align-items:center;gap:8px;}
    header h2::before{content:"★";font-size:18px;}
    .troop-home-link{text-decoration:none;color:inherit;display:inline-flex;align-items:center;}
    .troop-home-link:hover h2{opacity:.9;text-decoration:underline;}
    nav{display:flex;gap:12px;font-size:13px;text-transform:uppercase;}
    nav a{
      color:#1f4e79;font-weight:bold;text-decoration:none;padding:6px 10px;border-radius:var(--radius-pill);
      border:1px solid rgba(255,255,255,.25);backdrop-filter:blur(4px);opacity:.9;
    }
    nav a:hover{opacity:1;background:rgba(255,255,255,.12);}
    #auth-bar{display:flex;gap:10px;align-items:center;font-size:13px;}
    .auth-btn{
      padding:5px 12px;font-size:13px;border-radius:var(--radius-pill);
      border:1px solid rgba(255,255,255,.7);background:rgba(255,255,255,.1);color:var(--white);
      cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;
    }
    .auth-btn:hover{background:rgba(255,255,255,.2);}
    main{padding:24px 16px 40px;max-width:960px;margin:0 auto;}

    .welcome-card{
      background:rgba(255,255,255,.95);
      border-radius:var(--radius-lg);
      padding:18px 18px 8px;
      margin-bottom:20px;
      box-shadow:var(--shadow-soft);
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      border:1px solid rgba(148,163,184,.4);
    }
    .welcome-card h3{margin:0 0 4px;font-size:18px;}
    .welcome-card p{margin:0;font-size:14px;color:var(--text-muted);}

    section{
      background:rgba(255,255,255,.95);
      border-radius:var(--radius-lg);
      padding:18px 18px 14px;
      margin-bottom:18px;
      box-shadow:var(--shadow-soft);
      border:1px solid rgba(148,163,184,.4);
    }
    section h2{margin-top:0;font-size:18px;display:flex;align-items:center;gap:8px;}
    section h2::before{content:"▸";font-size:14px;color:var(--blue);}
    .small-help{font-size:12px;color:var(--text-muted);margin-top:6px;line-height:1.35;}

    .debug{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(148,163,184,.10);
      color:#334155;
      font-size:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      white-space:pre-wrap;
    }
    .error{
      margin-top:10px;padding:10px 12px;border-radius:12px;
      border:1px solid rgba(185,28,28,.35);
      background:rgba(185,28,28,.08);
      color:#991b1b;
      display:none;font-size:13px;
    }
    .error.show{display:block;}

    .req{
      border-radius:14px;
      border:1px solid rgba(31,78,121,0.18);
      background:rgba(31,78,121,0.06);
      padding:12px;
      margin-top:10px;
    }
    .req-top{display:flex;gap:10px;justify-content:space-between;align-items:flex-start;}
    .req-text{font-size:14px;line-height:1.35;}
    .pill{
      font-size:11px;padding:4px 8px;border-radius:var(--radius-pill);
      border:1px solid rgba(148,163,184,.6);
      background:rgba(255,255,255,.65);
      color:var(--text-muted);
      text-transform:uppercase;letter-spacing:.06em;white-space:nowrap;height:fit-content;
    }
    .pill.requested{border-color:rgba(245,158,11,.6);color:#92400e;background:rgba(245,158,11,.10);}
    .pill.approved{border-color:rgba(34,197,94,.6);color:#166534;background:rgba(34,197,94,.10);}
    .pill.denied{border-color:rgba(239,68,68,.6);color:#991b1b;background:rgba(239,68,68,.10);}

    .btnrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
    .btn{
      padding:7px 12px;border-radius:var(--radius-pill);
      border:none;cursor:pointer;font-weight:650;font-size:13px;
    }
    .btn.primary{background:var(--blue);color:#fff;}
    .btn.approve{background:rgba(34,197,94,0.18);border:1px solid rgba(34,197,94,0.35);color:#166534;}
    .btn.deny{background:rgba(239,68,68,0.14);border:1px solid rgba(239,68,68,0.35);color:#991b1b;}
    .btn:disabled{opacity:.55;cursor:not-allowed;}
    .meta{margin-top:6px;font-size:12px;color:var(--text-muted);}
  </style>
</head>

<body>
  <header>
    <div>
      <a href="/home" class="troop-home-link"><h2>Troop 248</h2></a>
    </div>
    <nav>
      <a href="/home">Home</a>
      <a href="/calendar">Calendar</a>
      <a href="/documents">Documents</a>
      <a href="/scoutmaster">SM Blog</a>
      <a href="/spl">SPL Blog</a>
      <a href="/useful-links">Useful Links</a>
      <a href="/events">Events</a>
      <a href="/mail">Mail</a>
      <a href="/advancements">Advancements</a>
    </nav>
    <div id="auth-bar">
      <div id="auth-info">Not signed in</div>
      <a id="login-link" class="auth-btn" href="/login/">Log In</a>
    </div>
  </header>

  <main>
    <div class="welcome-card">
      <div>
        <h3 id="mb-title">Merit Badge</h3>
        <p id="mb-sub">Loading…</p>
      </div>
      <div>
        <span id="role-pill" class="pill">Guest</span>
      </div>
    </div>

    <section>
      <h2>Debug</h2>
      <div class="small-help">This box will tell you exactly why “nothing shows.”</div>
      <div id="debug" class="debug">booting…</div>
      <div id="errBox" class="error"></div>
    </section>

    <section>
      <h2>Requirements</h2>
      <div class="small-help">Requirements come from <strong>meritBadgeCatalog/{slug}/requirements</strong>.</div>
      <div id="reqList"></div>
      <div id="empty" class="small-help" style="display:none;margin-top:10px;">
        No requirements found. Add docs under meritBadgeCatalog/{slug}/requirements.
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD5qUHa2JuQ3iI7U3DrX7JDyhx76PGzhxM",
      authDomain: "troop-248.firebaseapp.com",
      projectId: "troop-248",
      storageBucket: "troop-248.firebasestorage.app",
      messagingSenderId: "925363875752",
      appId: "1:925363875752:web:0b001c1a7a09fb8232f79d",
      measurementId: "G-NY75GX5TBH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const parts = location.pathname.split("/").filter(Boolean);
    const slug = parts[parts.length - 1]; // robust vs trailing slash

    const mbTitle = document.getElementById("mb-title");
    const mbSub = document.getElementById("mb-sub");
    const reqList = document.getElementById("reqList");
    const emptyEl = document.getElementById("empty");
    const rolePill = document.getElementById("role-pill");
    const authInfoEl = document.getElementById("auth-info");
    const loginLink = document.getElementById("login-link");
    const debugEl = document.getElementById("debug");
    const errBox = document.getElementById("errBox");

    function setDebug(obj){
      debugEl.textContent = JSON.stringify(obj, null, 2);
    }
    function showError(msg){
      errBox.textContent = msg;
      errBox.classList.add("show");
    }
    function clearError(){
      errBox.textContent = "";
      errBox.classList.remove("show");
    }

    async function getBadgeName() {
      try {
        const res = await fetch("/advancements/merit-badges/merit-badges.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Could not fetch merit-badges.json");
        const list = await res.json();
        const found = list.find(x => x.slug === slug);
        return found?.name || slug.replace(/-/g, " ");
      } catch {
        return slug.replace(/-/g, " ");
      }
    }

    function pillForStatus(status){
      const s = status || "not_started";
      const el = document.createElement("span");
      el.className = "pill " + (s === "not_started" ? "" : s);
      el.textContent =
        s === "not_started" ? "Not started" :
        s === "requested" ? "Requested" :
        s === "approved" ? "Approved" :
        s === "denied" ? "Denied" : s;
      return el;
    }

    async function renderRequirements({ user, isAdmin, isScout }) {
      clearError();
      reqList.innerHTML = "";
      emptyEl.style.display = "none";

      // Load catalog requirements
      let reqSnap;
      try {
        reqSnap = await getDocs(collection(db, "meritBadgeCatalog", slug, "requirements"));
      } catch (e) {
        showError("Could not read meritBadgeCatalog requirements (likely Firestore rules).");
        setDebug({ slug, step: "getDocs(catalog)", error: e?.message || String(e) });
        return;
      }

      const reqDocs = reqSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      if (reqDocs.length === 0) {
        emptyEl.style.display = "block";
        return;
      }

      // Sort if you have a "sort" field
      reqDocs.sort((a,b) => (a.sort ?? 999999) - (b.sort ?? 999999));

      for (const r of reqDocs) {
        const progressRef = doc(db, "users", user.uid, "meritBadges", slug, "requirements", r.id);

        let progress = { status: "not_started" };
        try {
          const pSnap = await getDoc(progressRef);
          if (pSnap.exists()) progress = pSnap.data() || progress;
        } catch (e) {
          showError("Could not read your progress doc (likely Firestore rules).");
          setDebug({ slug, step: "getDoc(progress)", reqId: r.id, error: e?.message || String(e) });
          return;
        }

        const wrap = document.createElement("div");
        wrap.className = "req";

        const top = document.createElement("div");
        top.className = "req-top";

        const text = document.createElement("div");
        text.className = "req-text";
        text.textContent = r.text || "(no text)";

        const pill = pillForStatus(progress.status);
        top.appendChild(text);
        top.appendChild(pill);

        wrap.appendChild(top);

        const meta = document.createElement("div");
        meta.className = "meta";
        if (progress.status === "approved" && progress.decidedByName) {
          meta.textContent = `Approved by ${progress.decidedByName}`;
        } else if (progress.status === "denied" && progress.decidedByName) {
          meta.textContent = `Denied by ${progress.decidedByName}`;
        } else if (progress.status === "requested") {
          meta.textContent = "Requested approval (awaiting admin review)";
        }
        wrap.appendChild(meta);

        const btnrow = document.createElement("div");
        btnrow.className = "btnrow";

        // Scout self: request button
        if (!isAdmin && isScout) {
          const btn = document.createElement("button");
          btn.className = "btn primary";
          btn.textContent =
            progress.status === "requested" ? "Requested" :
            progress.status === "approved" ? "Approved" :
            progress.status === "denied" ? "Request again" : "Request completion";
          btn.disabled = (progress.status === "requested" || progress.status === "approved");

          btn.onclick = async () => {
            try {
              // IMPORTANT: setDoc, not updateDoc (works even if doc doesn't exist)
              await setDoc(progressRef, {
                status: "requested",
                requestedAt: serverTimestamp(),
                decidedAt: null,
                decidedByUid: null,
                decidedByName: null
              }, { merge: true });

              // re-render
              renderRequirements({ user, isAdmin, isScout });
            } catch (e) {
              showError("Request write failed (likely Firestore rules).");
              setDebug({ slug, step: "setDoc(requested)", reqId: r.id, error: e?.message || String(e) });
            }
          };

          btnrow.appendChild(btn);
        }

        // Admin controls for *their own* UID are not enough; this page is “self-view” only.
        // We'll add the admin scout-selector version next (separate page), once this loads correctly.

        if (btnrow.children.length) wrap.appendChild(btnrow);
        reqList.appendChild(wrap);
      }
    }

    onAuthStateChanged(auth, async (user) => {
      const badgeName = await getBadgeName();
      mbTitle.textContent = badgeName;
      mbSub.textContent = `Slug: ${slug}`;

      if (!user) {
        authInfoEl.textContent = "Not signed in";
        rolePill.textContent = "Guest";
        loginLink.style.display = "";
        setDebug({ slug, auth: "none", note: "Sign in to view your progress." });
        return;
      }

      loginLink.style.display = "none";
      authInfoEl.textContent = `Signed in as ${user.email}`;

      // Load accountInfo
      let info;
      try {
        const infoSnap = await getDoc(doc(db, "accountInfo", user.uid));
        info = infoSnap.exists() ? (infoSnap.data() || {}) : {};
      } catch (e) {
        showError("Could not read accountInfo (rules).");
        setDebug({ slug, step: "getDoc(accountInfo)", error: e?.message || String(e) });
        return;
      }

      const authRole = info.authRole || null;
      const accountType = info.accountType || null;
      const isAdmin = authRole === "admin";
      const isScout = accountType === "scout";

      rolePill.textContent = isAdmin ? "Admin" : (accountType || "Viewer");

      setDebug({
        slug,
        user: user.uid,
        email: user.email,
        authRole,
        accountType,
        isAdmin,
        isScout
      });

      if (!isScout && !isAdmin) {
        showError("Scouts only (unless you are an Admin).");
        return;
      }

      // For now: show ONLY the signed-in user's progress (admin scout-selector comes next)
      await renderRequirements({ user, isAdmin, isScout });
    });
  </script>
</body>
</html>
