<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Troop 248 — Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/bsafavicon.ico">
  <style>
    :root {
      --red: #b22222;
      --blue: #1f4e79;
      --tan: #f4eee3;
      --white: #ffffff;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --radius-lg: 16px;
      --radius-pill: 999px;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.06);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #d2cab6;
      color: var(--text-main);
      min-height: 100vh;
    }

    header {
      background: linear-gradient(120deg, #b22222, #ffffff, #1f4e79);
      color: var(--white);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h2 {
      margin: 0;
      font-size: 19px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header h2::before { content: "★"; font-size: 18px; }

    .troop-home-link {
      text-decoration: none;
      color: inherit;
      display: inline-flex;
      align-items: center;
    }
    .troop-home-link:hover h2 {
      opacity: 0.9;
      text-decoration: underline;
    }

    nav {
      display: flex;
      gap: 12px;
      font-size: 13px;
      text-transform: uppercase;
    }

    nav a {
      color: #1f4e79;
      font-weight: bold;
      text-decoration: none;
      padding: 6px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(4px);
      opacity: 0.9;
    }
    nav a:hover { opacity: 1; background: rgba(255, 255, 255, 0.12); }

    #auth-bar {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 13px;
    }

    #logout-btn {
      padding: 5px 12px;
      font-size: 13px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.7);
      background: rgba(255, 255, 255, 0.1);
      color: var(--white);
      cursor: pointer;
    }
    #logout-btn:hover { background: rgba(255, 255, 255, 0.2); }

    main {
      padding: 24px 16px 40px;
      max-width: 960px;
      margin: 0 auto;
    }

    .welcome-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--radius-lg);
      padding: 20px 18px 12px;
      margin-bottom: 14px;
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .welcome-card h3 { margin: 0 0 6px; font-size: 20px; }
    .welcome-card p { margin: 0; font-size: 14px; color: var(--text-muted); }

    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: var(--radius-pill);
      background: rgba(148, 163, 184, 0.2);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }
    .badge.admin {
      background: rgba(240, 180, 41, 0.16);
      color: #92400e;
      border: 1px solid rgba(245, 158, 11, 0.6);
    }

    section {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--radius-lg);
      padding: 18px 18px 16px;
      margin-bottom: 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    section h2 {
      margin-top: 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    section h2::before { content: "▸"; font-size: 14px; color: var(--blue); }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
      margin-top: 8px;
    }
    @media (max-width: 720px) {
      .grid { grid-template-columns: minmax(0, 1fr); }
    }

    .feature-card-link { text-decoration: none; color: inherit; }

    .feature-card {
      border-radius: 14px;
      padding: 12px 12px 10px;
      border: 1px solid rgba(209,213,219,.9);
      background: #f9fafb;
      box-shadow: 0 4px 12px rgba(0,0,0,.04);
      transition: transform .1s ease, box-shadow .1s ease, border-color .1s ease;
    }
    .feature-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0,0,0,.06);
      border-color: rgba(148,163,184,.9);
    }

    .feature-title { font-size: 15px; font-weight: 600; margin: 0 0 4px; }
    .feature-badge {
      display: inline-block;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      background: rgba(31,78,121,.08);
      color: var(--blue);
      text-transform: uppercase;
      letter-spacing: .07em;
      margin-bottom: 4px;
    }
    .feature-text { font-size: 13px; color: var(--text-muted); margin: 0; }

    .quick-note { font-size: 12px; color: var(--text-muted); margin-top: 8px; }

    /* --- Daily streak card (fun but still tasteful) --- */
    .streak-card {
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--radius-lg);
      padding: 14px 14px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .streak-left h4 {
      margin: 0 0 2px;
      font-size: 14px;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .streak-value {
      display: flex;
      align-items: baseline;
      gap: 10px;
    }

    .streak-number {
      font-size: 28px;
      font-weight: 800;
      line-height: 1;
      color: #111827;
    }

    .streak-days {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .05em;
    }

    .streak-sub {
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .streak-right {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 170px;
      justify-content: flex-end;
    }

    .streak-flame {
      width: 46px;
      height: 46px;
      border-radius: 14px;
      position: relative;
      background: radial-gradient(circle at 30% 30%, rgba(255, 210, 120, .95), rgba(255, 120, 40, .9), rgba(180, 40, 20, .9));
      box-shadow: 0 10px 24px rgba(180, 60, 20, .20);
      transform: rotate(-2deg);
    }

    .streak-flame::before,
    .streak-flame::after {
      content: "";
      position: absolute;
      inset: 10px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.85), rgba(255, 220, 140, .8), rgba(255, 120, 40, .2));
      filter: blur(.2px);
      transform: rotate(8deg);
      opacity: .85;
    }

    .streak-flame::after {
      inset: 16px;
      opacity: .75;
      transform: rotate(-12deg);
    }

    .streak-pill {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148,163,184,.7);
      background: rgba(31,78,121,.06);
      color: var(--blue);
      font-weight: 700;
      letter-spacing: .04em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    /* Pop animation when streak increases */
    .streak-card.boom {
      animation: streakPop 650ms ease;
    }
    @keyframes streakPop {
      0% { transform: translateY(0) scale(1); }
      35% { transform: translateY(-2px) scale(1.02); }
      100% { transform: translateY(0) scale(1); }
    }

    .streak-card.boom .streak-flame {
      animation: flameWiggle 650ms ease;
    }
    @keyframes flameWiggle {
      0% { transform: rotate(-2deg) scale(1); }
      35% { transform: rotate(6deg) scale(1.05); }
      70% { transform: rotate(-6deg) scale(1.06); }
      100% { transform: rotate(-2deg) scale(1); }
    }

    /* Confetti-ish sparks (no audio) */
    .sparks {
      pointer-events: none;
      position: absolute;
      inset: 0;
      opacity: 0;
    }
    .streak-card.boom .sparks {
      opacity: 1;
      animation: sparksFade 650ms ease forwards;
    }
    @keyframes sparksFade {
      0% { opacity: 0; }
      15% { opacity: 1; }
      100% { opacity: 0; }
    }

    .spark {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255, 120, 40, .9);
      box-shadow: 0 0 0 6px rgba(255, 180, 80, .18);
      animation: sparkFly 650ms ease forwards;
    }
    @keyframes sparkFly {
      0% { transform: translate(0,0) scale(1); opacity: 1; }
      100% { transform: translate(var(--dx), var(--dy)) scale(.6); opacity: 0; }
    }

    @media (max-width: 640px) {
      header { flex-direction: column; align-items: flex-start; gap: 8px; }
      nav { width: 100%; justify-content: flex-start; flex-wrap: wrap; }
      .welcome-card { flex-direction: column; align-items: flex-start; }
      .streak-card { flex-direction: column; align-items: flex-start; }
      .streak-right { width: 100%; justify-content: flex-start; }
    }

    .streak-flame-img{
  width: 46px;
  height: 46px;
  border-radius: 14px;
  object-fit: contain;
  box-shadow: 0 10px 24px rgba(0,0,0,.14);
  transform: rotate(-2deg);
}

/* keep your “boom” animation working */
.streak-card.boom .streak-flame-img{
  animation: flameWiggle 650ms ease;
}
  </style>
  <link rel="stylesheet" href="/modern-2026.css" />
</head>
<body>
  <header>
    <div>
      <a href="/home" class="troop-home-link"><h2>Troop 248</h2></a>
    </div>

    <nav>
      <a href="/calendar">Calendar</a>
      <a href="/documents">Documents</a>
      <a href="/scoutmaster">SM Blog</a>
      <a href="/spl">SPL Blog</a>
      <a href="/useful-links">Useful Links</a>
      <a href="/events">Events</a>
      <a href="/mail">Mail</a>
    </nav>

    <div id="auth-bar">
      <div id="auth-info">Signed in as …</div>
      <button id="logout-btn">Log Out</button>
    </div>
  </header>

  <main>
    <div class="welcome-card">
      <div>
        <h3>Welcome to Troop 248 Portal</h3>
        <p>This private site is for Troop 248 Scouts, parents, and adult leaders.</p>
      </div>
      <div id="role-badge-container"><span class="badge">Viewer</span></div>
    </div>

    <!-- Daily Streak -->
    <div class="streak-card" id="streak-card" aria-live="polite">
      <div class="sparks" id="sparks"></div>

      <div class="streak-left">
        <h4>Daily Streak</h4>
        <div class="streak-value">
          <div class="streak-number" id="streak-number">—</div>
          <div class="streak-days">days</div>
        </div>
        <div class="streak-sub" id="streak-sub">Loading…</div>
      </div>

      <div class="streak-right">
        <img
  class="streak-flame-img"
  src="/streak-fire.webp"
  alt=""
  aria-hidden="true"
/>
        <div class="streak-pill" id="streak-pill">Keep it going</div>
      </div>
    </div>

    <section>
      <h2>Troop Resources</h2>

      <!-- ✅ Troop Resources Search -->
<div class="searchbar" style="margin: 10px 0 12px;">
  <input
    id="resourcesSearch"
    type="search"
    placeholder="Search Troop Resources…"
    autocomplete="off"
    style="
      width: min(520px, 100%);
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #000;
      outline: none;
      background: rgba(255,255,255,.85);
      font-size: 14px;
    "
  />
</div>

      <div class="grid">
        <a href="/calendar" class="feature-card-link" data-title="Troop Calendar">
          <div class="feature-card">
            <div class="feature-badge">Schedule</div>
            <h3 class="feature-title">Troop Calendar</h3>
            <p class="feature-text">See upcoming meetings, campouts, service projects, and board of reviews.</p>
          </div>
        </a>

        <a href="/documents" class="feature-card-link" data-title="Documents">
          <div class="feature-card">
            <div class="feature-badge">Forms</div>
            <h3 class="feature-title">Troop Documents</h3>
            <p class="feature-text">Find meeting plans, packing lists, medical forms, and other important paperwork.</p>
          </div>
        </a>

        <a href="/scoutmaster" class="feature-card-link" data-title="Scoutmaster Blog">
          <div class="feature-card">
            <div class="feature-badge">Leadership</div>
            <h3 class="feature-title">Scoutmaster Blog</h3>
            <p class="feature-text">Read messages and updates directly from the Scoutmaster to the troop.</p>
          </div>
        </a>

        <a href="/spl" class="feature-card-link" data-title="SPL Blog">
          <div class="feature-card">
            <div class="feature-badge">Youth Led</div>
            <h3 class="feature-title">SPL Blog</h3>
            <p class="feature-text">Hear from the Senior Patrol Leader about plans, goals, and upcoming activities.</p>
          </div>
        </a>

        <a href="/useful-links" class="feature-card-link" data-title="Useful Links">
          <div class="feature-card">
            <div class="feature-badge">Resources</div>
            <h3 class="feature-title">Useful Links</h3>
            <p class="feature-text">Browse helpful websites for advancement, camping, merit badges, and parent info.</p>
          </div>
        </a>

        <a href="/events" class="feature-card-link" data-title="Events">
          <div class="feature-card">
            <div class="feature-badge">Campouts/Service</div>
            <h3 class="feature-title">Events</h3>
            <p class="feature-text">View and prepare for upcoming events.</p>
          </div>
        </a>

        <a href="/mail" class="feature-card-link" data-title="Mail">
          <div class="feature-card">
            <div class="feature-badge">Contact</div>
            <h3 class="feature-title">Mail</h3>
            <p class="feature-text">Reach out to other members of the troop through an electronic mailing system, often referred to as "e-mail" or "email".</p>
          </div>
        </a>

        <a href="/messaging" class="feature-card-link" data-title="Messaging">
          <div class="feature-card">
            <div class="feature-badge">Contact</div>
            <h3 class="feature-title">Messaging</h3>
            <p class="feature-text">Reach out to other members of the troop through chat.</p>
          </div>
        </a>

        <a href="/roster" class="feature-card-link" data-title="Roster">
          <div class="feature-card">
            <div class="feature-badge">Roster</div>
            <h3 class="feature-title">Roster</h3>
            <p class="feature-text">View contact info for anyone in the troop.</p>
          </div>
        </a>

        <a href="/patrols" class="feature-card-link" data-title="Patrols">
          <div class="feature-card">
            <div class="feature-badge">Patrols</div>
            <h3 class="feature-title">Patrols</h3>
            <p class="feature-text">View scout accounts and assigned patrols.</p>
          </div>
        </a>

        <a href="/report" class="feature-card-link" data-title="Report">
          <div class="feature-card">
            <div class="feature-badge">Report</div>
            <h3 class="feature-title">Report</h3>
            <p class="feature-text">Report any problems/suggestions for the website to the devs.</p>
          </div>
        </a>

        <a href="/accountinfo" class="feature-card-link" data-title="Account Info">
          <div class="feature-card">
            <div class="feature-badge">Account</div>
            <h3 class="feature-title">Account Info</h3>
            <p class="feature-text">View and edit personal account info.</p>
          </div>
        </a>
      </div>

      <div class="quick-note">
        Your access level (Viewer / Admin) controls whether you can edit content or just view it.
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD5qUHa2JuQ3iI7U3DrX7JDyhx76PGzhxM",
      authDomain: "troop-248.firebaseapp.com",
      projectId: "troop-248",
      storageBucket: "troop-248.firebasestorage.app",
      messagingSenderId: "925363875752",
      appId: "1:925363875752:web:0b001c1a7a09fb8232f79d",
      measurementId: "G-NY75GX5TBH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authInfoEl = document.getElementById("auth-info");
    const logoutBtn = document.getElementById("logout-btn");
    const roleBadgeContainer = document.getElementById("role-badge-container");

    // streak UI
    const streakCard = document.getElementById("streak-card");
    const streakNumberEl = document.getElementById("streak-number");
    const streakSubEl = document.getElementById("streak-sub");
    const streakPillEl = document.getElementById("streak-pill");
    const sparksEl = document.getElementById("sparks");

    let currentUser = null;
    let currentIsAdmin = false;

    function updateRoleUI() {
      if (!currentUser) return;
      authInfoEl.textContent = `Signed in as ${currentUser.email}`;
      roleBadgeContainer.innerHTML = `
        <span class="badge ${currentIsAdmin ? "admin" : ""}">
          ${currentIsAdmin ? "Admin" : "Viewer"}
        </span>`;
    }

    // Returns YYYY-MM-DD for America/New_York
    function nycDateKey(date = new Date()) {
      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: "America/New_York",
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      }).formatToParts(date);

      const y = parts.find(p => p.type === "year")?.value;
      const m = parts.find(p => p.type === "month")?.value;
      const d = parts.find(p => p.type === "day")?.value;
      return `${y}-${m}-${d}`;
    }

    function daysBetween(dateKeyA, dateKeyB) {
      // dateKey: YYYY-MM-DD. Compare as UTC midnights to avoid DST issues.
      const [ay, am, ad] = dateKeyA.split("-").map(Number);
      const [by, bm, bd] = dateKeyB.split("-").map(Number);
      const a = Date.UTC(ay, am - 1, ad);
      const b = Date.UTC(by, bm - 1, bd);
      return Math.round((b - a) / 86400000);
    }

    function spawnSparks() {
      sparksEl.innerHTML = "";
      const sparks = 10;
      for (let i = 0; i < sparks; i++) {
        const s = document.createElement("div");
        s.className = "spark";
        const left = 55 + Math.random() * 40;  // bias to right side near flame
        const top = 10 + Math.random() * 70;

        const dx = (Math.random() * 120 - 60).toFixed(0) + "px";
        const dy = (Math.random() * -120 - 40).toFixed(0) + "px";

        s.style.left = left + "%";
        s.style.top = top + "%";
        s.style.setProperty("--dx", dx);
        s.style.setProperty("--dy", dy);
        sparksEl.appendChild(s);
      }
    }

    function playStreakAnimation() {
      spawnSparks();
      streakCard.classList.remove("boom");
      // force reflow so animation re-triggers
      void streakCard.offsetWidth;
      streakCard.classList.add("boom");
    }

    async function updateDailyStreak(userUid) {
      const today = nycDateKey(new Date());
      const ref = doc(db, "accountInfo", userUid);
      const snap = await getDoc(ref);

      // If missing doc, pending flow elsewhere should catch it, but be safe:
      if (!snap.exists()) {
        streakNumberEl.textContent = "—";
        streakSubEl.textContent = "Streak unavailable.";
        return;
      }

      const data = snap.data() || {};
      const last = (data.lastStreakDate || "").trim();
      const currentCount = Number.isFinite(data.streakCount) ? data.streakCount : 0;

      // First time ever:
      if (!last) {
        await setDoc(ref, { lastStreakDate: today, streakCount: 1 }, { merge: true });
        streakNumberEl.textContent = "1";
        streakSubEl.textContent = "First day streak — nice.";
        streakPillEl.textContent = "New streak!";
        playStreakAnimation();
        return;
      }

      // Already logged today:
      if (last === today) {
        const showCount = currentCount > 0 ? currentCount : 1;
        streakNumberEl.textContent = String(showCount);
        streakSubEl.textContent = "Logged today. Come back tomorrow to keep it going.";
        streakPillEl.textContent = "Locked in";
        return;
      }

      const diff = daysBetween(last, today);

      // If last date is in the future (device clock weird), don't update:
      if (diff < 0) {
        const showCount = currentCount > 0 ? currentCount : 1;
        streakNumberEl.textContent = String(showCount);
        streakSubEl.textContent = "Streak active.";
        streakPillEl.textContent = "Ready";
        return;
      }

      let newCount = 1;
      let subtitle = "Streak restarted — today counts.";

      if (diff === 1) {
        newCount = (currentCount > 0 ? currentCount : 1) + 1;
        subtitle = "Streak increased — keep it going tomorrow.";
      }

      await setDoc(ref, { lastStreakDate: today, streakCount: newCount }, { merge: true });

      streakNumberEl.textContent = String(newCount);
      streakSubEl.textContent = subtitle;
      streakPillEl.textContent = diff === 1 ? "Streak up!" : "Restarted";
      playStreakAnimation();
    }

    async function handleAuth(user) {
      if (!user) { window.location.href = "/"; return; }

      const infoRef = doc(db, "accountInfo", user.uid);
      const infoSnap = await getDoc(infoRef);

      if (!infoSnap.exists()) { window.location.href = "/under-review/"; return; }

      const role = infoSnap.data().authRole;
      if (role !== "admin" && role !== "viewer") { window.location.href = "/under-review/"; return; }

      currentUser = user;
      currentIsAdmin = role === "admin";
      updateRoleUI();

      // streak update
      await updateDailyStreak(user.uid);
    }

    onAuthStateChanged(auth, handleAuth);

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "/";
    });

    // ✅ Home: filter Troop Resources cards by title
const resourcesSearch = document.getElementById("resourcesSearch");
if (resourcesSearch) {
  const cards = Array.from(document.querySelectorAll(".feature-card-link[data-title]"));

  function filterResources() {
    const q = (resourcesSearch.value || "").trim().toLowerCase();
    cards.forEach((a) => {
      const title = (a.getAttribute("data-title") || "").toLowerCase();
      a.style.display = !q || title.includes(q) ? "" : "none";
    });
  }

  resourcesSearch.addEventListener("input", filterResources);
}
  </script>
</body>
</html>
