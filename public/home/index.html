<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Troop 248</title>

  <!-- Optional: your existing CSS -->
  <link rel="stylesheet" href="/styles.css" />

  <style>
    /* simple safety styling if CSS doesn't load */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .wrap { padding: 24px; max-width: 1000px; margin: 0 auto; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Troop 248</h1>

    <!-- This shows only while auth loads -->
    <p id="status">Loading…</p>

    <!-- Put your normal page content below (leave as-is if you want) -->
    <div id="content" style="display:none;">
      <p>Welcome to the Troop 248 website.</p>

      <!-- Example: logout button (only shown when logged in) -->
      <button id="logoutBtn" style="display:none;">Log out</button>

      <!-- If you already had content, paste it here -->
    </div>
  </div>

  <!-- ========== FIXED REDIRECT / AUTH LOGIC ========== -->
  <script type="module">
    /*************************************************************
     * ✅ This file fixes infinite refresh/redirect loops.
     * - Never uses location.reload()
     * - Redirects only once
     * - Doesn't redirect if you're already on the target page
     * - Adds bypass: ?noredirect=1
     *************************************************************/

    // ---- Redirect bypass for debugging ----
    const params = new URLSearchParams(window.location.search);
    const NO_REDIRECT = params.has("noredirect");

    // ---- Safe redirect helper: prevents loops ----
    const redirectOnce = (url) => {
      try {
        if (NO_REDIRECT) return;

        const current = window.location.pathname.replace(/\/+$/, "") || "/";
        const targetPath = new URL(url, window.location.origin).pathname.replace(/\/+$/, "") || "/";

        // don't redirect if already there
        if (current === targetPath) return;

        // prevent repeated redirects in the same tab session
        const KEY = "__redirected_to__";
        const last = sessionStorage.getItem(KEY);
        if (last === targetPath) return;

        sessionStorage.setItem(KEY, targetPath);
        window.location.replace(url);
      } catch (e) {
        console.error("redirectOnce error:", e);
      }
    };

    // ---- Firebase imports ----
    // IMPORTANT: these should match how you already use Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // ---- Your Firebase config ----
    // ✅ Paste YOUR existing config values here
    const firebaseConfig = {
      apiKey: "AIzaSyD5qUHa2JuQ3iI7U3DrX7JDyhx76PGzhxM",
  authDomain: "troop-248.firebaseapp.com",
  projectId: "troop-248",
  storageBucket: "troop-248.firebasestorage.app",
  messagingSenderId: "925363875752",
  appId: "1:925363875752:web:0b001c1a7a09fb8232f79d",
  measurementId: "G-NY75GX5TBH"
    };

    // ---- Init ----
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const statusEl = document.getElementById("status");
    const contentEl = document.getElementById("content");
    const logoutBtn = document.getElementById("logoutBtn");

    // ---- Logout (no reload!) ----
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);

          // Clear redirect lock so login works cleanly
          sessionStorage.removeItem("__redirected_to__");

          // Go to login page (change path if yours differs)
          redirectOnce("/");
        } catch (e) {
          console.error(e);
          alert("Logout failed. Please try again.");
        }
      });
    }

    // ---- Auth state (main fix) ----
    onAuthStateChanged(auth, (user) => {
      // Show page content once we know auth state
      statusEl.textContent = "";
      contentEl.style.display = "block";

      // If logged in
      if (user) {
        if (logoutBtn) logoutBtn.style.display = "inline-block";

        // ✅ If you have a "logged in home" page, you can redirect there
        // Example:
        // redirectOnce("/home/");
        return;
      }

      // If NOT logged in
      if (!user) {
        if (logoutBtn) logoutBtn.style.display = "none";

        // If home requires login, send to login safely:
        // Change "/login/" if your login page path is different
        redirectOnce("/login/");
      }
    });
  </script>
</body>
</html>
