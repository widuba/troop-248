<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mail — Troop 248</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/favicon.png">

  <!-- Styles -->
  <style>
    :root {
      --red:#b22222;
      --blue:#1f4e79;
      --tan:#f4eee3;
      --white:#ffffff;
      --text-main:#1f2933;
      --text-muted:#6b7280;
      --radius-lg:16px;
      --radius-pill:999px;
      --shadow-soft:0 10px 25px rgba(0,0,0,0.06);
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#d2cab6;
      color:var(--text-main);
      min-height:100vh;
    }

    header {
      background:linear-gradient(120deg,#b22222,#ffffff,#1f4e79);
      padding:14px 24px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:sticky;
      top:0;
      z-index:10;
    }

    header h2 {
      margin:0;
      font-size:19px;
      letter-spacing:.08em;
      text-transform:uppercase;
      display:flex;
      gap:8px;
      align-items:center;
    }

    header h2::before { content:"★"; }

    nav {
      display:flex;
      gap:12px;
      font-size:13px;
      text-transform:uppercase;
    }

    nav a {
      color:#1f4e79;
      font-weight:bold;
      text-decoration:none;
      padding:6px 10px;
      border-radius:var(--radius-pill);
      border:1px solid rgba(255,255,255,.25);
    }

    nav a:hover {
      background:rgba(255,255,255,.12);
    }

    main {
      max-width:1200px;
      margin:0 auto;
      padding:24px 16px 40px;
    }

    .mail-layout {
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:16px;
    }

    section {
      background:rgba(255,255,255,.96);
      border-radius:var(--radius-lg);
      padding:16px;
      box-shadow:var(--shadow-soft);
      border:1px solid rgba(148,163,184,.4);
      height:70vh;
      display:flex;
      flex-direction:column;
    }

    section h3 {
      margin:0 0 10px;
      font-size:16px;
      color:var(--blue);
    }

    .scroll {
      overflow-y:auto;
      flex:1;
    }

    .btn {
      padding:8px 14px;
      border:none;
      border-radius:var(--radius-pill);
      background:var(--blue);
      color:white;
      cursor:pointer;
      font-size:14px;
    }

    .btn:disabled {
      opacity:.5;
      cursor:not-allowed;
    }

    input, textarea {
      width:100%;
      padding:8px;
      border-radius:10px;
      border:1px solid #d1d5db;
      font-size:14px;
    }

    textarea {
      resize:vertical;
      min-height:140px;
    }

    .tri-toggle {
      display:flex;
      gap:6px;
      margin-bottom:10px;
    }

    .tri-toggle button {
      flex:1;
      border-radius:var(--radius-pill);
      border:1px solid rgba(148,163,184,.6);
      background:#f9fafb;
      padding:6px;
      cursor:pointer;
      font-size:13px;
    }

    .tri-toggle button.active {
      background:rgba(31,78,121,.1);
      border-color:var(--blue);
      font-weight:600;
    }

    .user-row {
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 0;
      border-bottom:1px solid rgba(229,231,235,.8);
      font-size:14px;
    }

    .user-row:last-child {
      border-bottom:none;
    }

    .mail-item {
      padding:8px 0;
      border-bottom:1px solid rgba(229,231,235,.8);
      cursor:pointer;
    }

    .mail-item:hover {
      background:rgba(31,78,121,.05);
    }

    .mail-subject {
      font-weight:600;
      font-size:14px;
    }

    .mail-meta {
      font-size:12px;
      color:var(--text-muted);
    }

    @media (max-width:900px) {
      .mail-layout {
        grid-template-columns:1fr;
      }
      section {
        height:auto;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <a href="/home" class="troop-home-link" style="text-decoration:none; color:inherit; display:inline-flex; align-items:center;">
        <h2>Troop 248</h2>
      </a>
    </div>

    <nav>
      <a href="/home">Home</a>
      <a href="/calendar">Calendar</a>
      <a href="/documents">Documents</a>
      <a href="/scoutmaster">Scoutmaster Blog</a>
      <a href="/spl-blog">SPL Blog</a>
      <a href="/useful-links">Useful Links</a>
      <a href="/events">Events</a>
      <a href="/mail">Mail</a>
    </nav>

    <div id="auth-bar" style="display:flex; gap:10px; align-items:center; font-size:13px;">
      <div id="auth-info">Signed in as …</div>
      <button id="logout-btn" style="padding:5px 12px; font-size:13px; border-radius:999px; border:1px solid rgba(255,255,255,.7); background:rgba(255,255,255,.1); color:#fff; cursor:pointer;">
        Log Out
      </button>
    </div>
  </header>

  <main>
    <div style="background:rgba(255,255,255,.96); border-radius:16px; padding:18px 18px 10px; margin-bottom:16px; box-shadow:0 10px 25px rgba(0,0,0,.06); border:1px solid rgba(148,163,184,.4); display:flex; align-items:center; justify-content:space-between; gap:16px;">
      <div>
        <div style="font-size:18px; font-weight:700; margin-bottom:4px;">Troop Mail</div>
        <div style="font-size:14px; color:#6b7280;">
          Message other signed-up members. Replies go to your email.
        </div>
        <div id="safety-note" style="font-size:12px; color:#6b7280; margin-top:6px;"></div>
      </div>
      <div id="role-badge" style="font-size:11px; padding:4px 8px; border-radius:999px; background:rgba(148,163,184,.2); color:#6b7280; text-transform:uppercase; letter-spacing:.07em;">
        Viewer
      </div>
    </div>

    <div class="mail-layout">
      <!-- LEFT: COMPOSE -->
      <section>
        <h3>Compose</h3>

        <div style="display:flex; gap:8px; margin-bottom:10px;">
          <button id="clear-selected" class="btn" type="button" style="background:rgba(31,78,121,.08); color:#1f4e79; border:1px solid rgba(148,163,184,.7);">
            Clear Recipients
          </button>
          <button id="clear-draft" class="btn" type="button" style="background:rgba(31,78,121,.08); color:#1f4e79; border:1px solid rgba(148,163,184,.7);">
            Clear Draft
          </button>
        </div>

        <form id="compose-form" style="display:flex; flex-direction:column; gap:10px;">
          <div>
            <label style="display:block; font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:.05em; margin-bottom:4px;">Subject</label>
            <input id="subject" type="text" maxlength="160" required />
          </div>

          <div style="flex:1;">
            <label style="display:block; font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:.05em; margin-bottom:4px;">Message</label>
            <textarea id="body" maxlength="5000" required></textarea>
          </div>

          <button id="send-btn" class="btn" type="submit" disabled>Send</button>

          <div id="compose-error" style="font-size:12px; color:#b91c1c;"></div>
          <div id="compose-success" style="font-size:12px; color:#166534;"></div>

          <div style="font-size:12px; color:#6b7280;">
            Selected: <b><span id="selected-count">0</span></b> • Adults selected: <b><span id="adult-count">0</span></b>
          </div>
        </form>
      </section>

      <!-- MIDDLE: RECIPIENTS -->
      <section>
        <h3>Recipients</h3>

        <div class="tri-toggle">
          <button id="tab-scouts" type="button" class="active">Scouts</button>
          <button id="tab-adults" type="button">Adult Leaders</button>
          <button id="tab-parents" type="button">Parents</button>
        </div>

        <div class="scroll" id="recipients-list">
          <div id="recipients-empty" style="font-size:14px; color:#6b7280;">Loading directory…</div>
        </div>

        <div style="font-size:12px; color:#6b7280; margin-top:10px;">
          Names show as: fullName → first+last → email (only if no name exists).
        </div>
      </section>

      <!-- RIGHT: INBOX -->
      <section>
        <h3>Inbox</h3>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
          <button id="inbox-tab" type="button" class="btn" style="padding:6px 12px; font-size:13px;">Inbox</button>
          <button id="sent-tab" type="button" class="btn" style="padding:6px 12px; font-size:13px; background:rgba(31,78,121,.08); color:#1f4e79; border:1px solid rgba(148,163,184,.7);">
            Sent
          </button>
          <button id="all-tab" type="button" class="btn" style="padding:6px 12px; font-size:13px; background:rgba(31,78,121,.08); color:#1f4e79; border:1px solid rgba(148,163,184,.7);">
            All
          </button>
        </div>

        <div class="scroll">
          <div id="mail-empty" style="font-size:14px; color:#6b7280;">Loading messages…</div>
          <div id="mail-list"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Logic -->
  <script type="module">
/* ================================
   Firebase Imports
================================ */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  getFirestore,
  collection,
  doc,
  getDoc,
  addDoc,
  onSnapshot,
  query,
  where,
  orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ================================
   Firebase Init
================================ */

const firebaseConfig = {
  apiKey: "AIzaSyD5qUHa2JuQ3iI7U3DrX7JDyhx76PGzhxM",
  authDomain: "troop-248.firebaseapp.com",
  projectId: "troop-248",
  storageBucket: "troop-248.firebasestorage.app",
  messagingSenderId: "925363875752",
  appId: "1:925363875752:web:0b001c1a7a09fb8232f79d",
  measurementId: "G-NY75GX5TBH"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================================
   Elements
================================ */

const authInfoEl = document.getElementById("auth-info");
const logoutBtn = document.getElementById("logout-btn");
const roleBadgeEl = document.getElementById("role-badge");

const subjectEl = document.getElementById("subject");
const bodyEl = document.getElementById("body");
const sendBtn = document.getElementById("send-btn");

const userListEl = document.getElementById("recipients-list");
const recipientsEmptyEl = document.getElementById("recipients-empty");

const tabScouts = document.getElementById("tab-scouts");
const tabParents = document.getElementById("tab-parents");
const tabAdults = document.getElementById("tab-adults");

const selectedCountEl = document.getElementById("selected-count");
const adultCountEl = document.getElementById("adult-count");
const safetyNoteEl = document.getElementById("safety-note");

const mailListEl = document.getElementById("mail-list");

/* ================================
   State
================================ */

let currentUser = null;
let myAccountType = "";
let activeTab = "scouts";

const directory = new Map();   // uid -> user
const selectedUids = new Set();
const mailMap = new Map();

/* ================================
   Helpers
================================ */

function norm(t){
  return (t || "").toLowerCase();
}

function isScout(t){ return norm(t).includes("scout"); }
function isParent(t){ return norm(t).includes("parent"); }
function isLeader(t){ return norm(t).includes("leader"); }
function isAdult(t){ return isParent(t) || isLeader(t); }

function displayName(u){
  if(u.fullName) return u.fullName;
  if(u.firstName || u.lastName)
    return `${u.firstName||""} ${u.lastName||""}`.trim();
  return u.email || "Unknown";
}

/* ================================
   Auth
================================ */

onAuthStateChanged(auth, async (user)=>{
  if(!user){
    location.href="/";
    return;
  }

  currentUser = user;
  authInfoEl.textContent = "Signed in as " + user.email;

  const snap = await getDoc(doc(db,"accountInfo",user.uid));
  if(!snap.exists()){
    location.href="/under-review/";
    return;
  }

  const info = snap.data();
  if(!["admin","viewer"].includes(info.authRole)){
    location.href="/under-review/";
    return;
  }

  myAccountType = info.accountType || "";

  roleBadgeEl.textContent = info.authRole;

  startDirectory();
  startMail();
});

logoutBtn.onclick = async ()=>{
  await signOut(auth);
  location.href="/";
};

/* ================================
   Directory
================================ */

function startDirectory(){
  onSnapshot(collection(db,"userDirectory"), snap=>{
    directory.clear();
    snap.forEach(d=>{
      directory.set(d.id, d.data());
    });
    renderUsers();
  });
}

function renderUsers(){
  userListEl.innerHTML="";

  const users = [...directory.entries()]
    .map(([uid,data])=>({uid,...data}))
    .filter(u=>u.uid!==currentUser.uid);

  let filtered=[];

  if(activeTab==="scouts") filtered=users.filter(u=>isScout(u.accountType));
  if(activeTab==="parents") filtered=users.filter(u=>isParent(u.accountType));
  if(activeTab==="adults") filtered=users.filter(u=>isLeader(u.accountType));

  if(filtered.length===0){
    recipientsEmptyEl.style.display="block";
    recipientsEmptyEl.textContent="No users in this group";
    updateCounts();
    return;
  }

  recipientsEmptyEl.style.display="none";

  filtered.sort((a,b)=>displayName(a).localeCompare(displayName(b)));

  filtered.forEach(u=>{
    const row=document.createElement("div");
    row.className="user-row";

    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.checked=selectedUids.has(u.uid);

    cb.onchange=()=>{
      if(cb.checked) selectedUids.add(u.uid);
      else selectedUids.delete(u.uid);
      updateCounts();
    };

    row.appendChild(cb);
    row.appendChild(document.createTextNode(" "+displayName(u)));
    userListEl.appendChild(row);
  });

  updateCounts();
}

/* ================================
   Tabs
================================ */

tabScouts.onclick=()=>{activeTab="scouts";renderUsers();};
tabParents.onclick=()=>{activeTab="parents";renderUsers();};
tabAdults.onclick=()=>{activeTab="adults";renderUsers();};

/* ================================
   Safety Rules
================================ */

function updateCounts(){
  let adults=0;
  selectedUids.forEach(uid=>{
    const u=directory.get(uid);
    if(u && isAdult(u.accountType)) adults++;
  });

  selectedCountEl.textContent=selectedUids.size;
  adultCountEl.textContent=adults;

  if(isAdult(myAccountType)){
    safetyNoteEl.textContent="Adult must include at least one adult.";
    sendBtn.disabled = adults < 1;
  }else{
    safetyNoteEl.textContent="Scout must include 0 or 2+ adults.";
    sendBtn.disabled = !(adults===0 || adults>=2);
  }
}

/* ================================
   Send Mail
================================ */

sendBtn.onclick = async ()=>{
  if(selectedUids.size===0){
    alert("Select at least one recipient");
    return;
  }

  if(!subjectEl.value.trim() || !bodyEl.value.trim()){
    alert("Subject and message required");
    return;
  }

  await addDoc(collection(db,"mailOutbox"),{
    fromUid: currentUser.uid,
    toUids: [...selectedUids],
    subject: subjectEl.value.trim(),
    body: bodyEl.value.trim(),
    senderAccountType: myAccountType,
    status:"queued",
    createdAt: serverTimestamp()
  });

  subjectEl.value="";
  bodyEl.value="";
  selectedUids.clear();
  renderUsers();
};

/* ================================
   Mail List
================================ */

function startMail(){

  onSnapshot(
    query(collection(db,"mailOutbox"),
      where("toUids","array-contains",currentUser.uid),
      orderBy("createdAt","desc")
    ),
    snap=>{
      mailMap.clear();
      snap.forEach(d=>mailMap.set(d.id,d.data()));
      renderMail();
    }
  );
}

function renderMail(){
  mailListEl.innerHTML="";
  [...mailMap.values()].forEach(m=>{
    const div=document.createElement("div");
    div.className="mail-item";
    div.innerHTML=`
      <b>${m.subject}</b><br>
      ${m.body}
    `;
    mailListEl.appendChild(div);
  });
}

</script>
</body>
</html>
