<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mail — Troop 248</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/favicon.png">

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    window.firebaseConfig = {
      apiKey: "AIzaSyD5qUHa2JuQ3iI7U3DrX7JDyhx76PGzhxM",
      authDomain: "troop-248.firebaseapp.com",
      projectId: "troop-248",
      storageBucket: "troop-248.firebasestorage.app",
      messagingSenderId: "925363875752",
      appId: "1:925363875752:web:0b001c1a7a09fb8232f79d",
      measurementId: "G-NY75GX5TBH"
    };

    window.firebaseApp = initializeApp(window.firebaseConfig);
    window.auth = getAuth(window.firebaseApp);
    window.db = getFirestore(window.firebaseApp);
  </script>

  <!-- Styles -->
  <style>
    :root {
      --red:#b22222;
      --blue:#1f4e79;
      --tan:#f4eee3;
      --white:#ffffff;
      --text-main:#1f2933;
      --text-muted:#6b7280;
      --radius-lg:16px;
      --radius-pill:999px;
      --shadow-soft:0 10px 25px rgba(0,0,0,0.06);
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#d2cab6;
      color:var(--text-main);
      min-height:100vh;
    }

    header {
      background:linear-gradient(120deg,#b22222,#ffffff,#1f4e79);
      padding:14px 24px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:sticky;
      top:0;
      z-index:10;
    }

    header h2 {
      margin:0;
      font-size:19px;
      letter-spacing:.08em;
      text-transform:uppercase;
      display:flex;
      gap:8px;
      align-items:center;
    }

    header h2::before { content:"★"; }

    nav {
      display:flex;
      gap:12px;
      font-size:13px;
      text-transform:uppercase;
    }

    nav a {
      color:#1f4e79;
      font-weight:bold;
      text-decoration:none;
      padding:6px 10px;
      border-radius:var(--radius-pill);
      border:1px solid rgba(255,255,255,.25);
    }

    nav a:hover {
      background:rgba(255,255,255,.12);
    }

    main {
      max-width:1200px;
      margin:0 auto;
      padding:24px 16px 40px;
    }

    .mail-layout {
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:16px;
    }

    section {
      background:rgba(255,255,255,.96);
      border-radius:var(--radius-lg);
      padding:16px;
      box-shadow:var(--shadow-soft);
      border:1px solid rgba(148,163,184,.4);
      height:70vh;
      display:flex;
      flex-direction:column;
    }

    section h3 {
      margin:0 0 10px;
      font-size:16px;
      color:var(--blue);
    }

    .scroll {
      overflow-y:auto;
      flex:1;
    }

    .btn {
      padding:8px 14px;
      border:none;
      border-radius:var(--radius-pill);
      background:var(--blue);
      color:white;
      cursor:pointer;
      font-size:14px;
    }

    .btn:disabled {
      opacity:.5;
      cursor:not-allowed;
    }

    input, textarea {
      width:100%;
      padding:8px;
      border-radius:10px;
      border:1px solid #d1d5db;
      font-size:14px;
    }

    textarea {
      resize:vertical;
      min-height:140px;
    }

    .tri-toggle {
      display:flex;
      gap:6px;
      margin-bottom:10px;
    }

    .tri-toggle button {
      flex:1;
      border-radius:var(--radius-pill);
      border:1px solid rgba(148,163,184,.6);
      background:#f9fafb;
      padding:6px;
      cursor:pointer;
      font-size:13px;
    }

    .tri-toggle button.active {
      background:rgba(31,78,121,.1);
      border-color:var(--blue);
      font-weight:600;
    }

    .user-row {
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 0;
      border-bottom:1px solid rgba(229,231,235,.8);
      font-size:14px;
    }

    .user-row:last-child {
      border-bottom:none;
    }

    .mail-item {
      padding:8px 0;
      border-bottom:1px solid rgba(229,231,235,.8);
      cursor:pointer;
    }

    .mail-item:hover {
      background:rgba(31,78,121,.05);
    }

    .mail-subject {
      font-weight:600;
      font-size:14px;
    }

    .mail-meta {
      font-size:12px;
      color:var(--text-muted);
    }

    @media (max-width:900px) {
      .mail-layout {
        grid-template-columns:1fr;
      }
      section {
        height:auto;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <a href="/home" class="troop-home-link" style="text-decoration:none; color:inherit; display:inline-flex; align-items:center;">
        <h2>Troop 248</h2>
      </a>
    </div>

    <nav>
      <a href="/home">Home</a>
      <a href="/calendar">Calendar</a>
      <a href="/documents">Documents</a>
      <a href="/scoutmaster">Scoutmaster Blog</a>
      <a href="/spl-blog">SPL Blog</a>
      <a href="/useful-links">Useful Links</a>
      <a href="/events">Events</a>
      <a href="/mail">Mail</a>
    </nav>

    <div id="auth-bar" style="display:flex; gap:10px; align-items:center; font-size:13px;">
      <div id="auth-info">Signed in as …</div>
      <button id="logout-btn" style="padding:5px 12px; font-size:13px; border-radius:999px; border:1px solid rgba(255,255,255,.7); background:rgba(255,255,255,.1); color:#fff; cursor:pointer;">
        Log Out
      </button>
    </div>
  </header>

  <main>
    <div style="background:rgba(255,255,255,.96); border-radius:16px; padding:18px 18px 10px; margin-bottom:16px; box-shadow:0 10px 25px rgba(0,0,0,.06); border:1px solid rgba(148,163,184,.4); display:flex; align-items:center; justify-content:space-between; gap:16px;">
      <div>
        <div style="font-size:18px; font-weight:700; margin-bottom:4px;">Troop Mail</div>
        <div style="font-size:14px; color:#6b7280;">
          Message other signed-up members. Replies go to your email.
        </div>
        <div id="safety-note" style="font-size:12px; color:#6b7280; margin-top:6px;"></div>
      </div>
      <div id="role-badge" style="font-size:11px; padding:4px 8px; border-radius:999px; background:rgba(148,163,184,.2); color:#6b7280; text-transform:uppercase; letter-spacing:.07em;">
        Viewer
      </div>
    </div>

    <div class="mail-layout">
      <!-- LEFT: COMPOSE -->
      <section>
        <h3>Compose</h3>

        <div style="display:flex; gap:8px; margin-bottom:10px;">
          <button id="clear-selected" class="btn" type="button" style="background:rgba(31,78,121,.08); color:#1f4e79; border:1px solid rgba(148,163,184,.7);">
            Clear Recipients
          </button>
          <button id="clear-draft" class="btn" type="button" style="background:rgba(31,78,121,.08); color:#1f4e79; border:1px solid rgba(148,163,184,.7);">
            Clear Draft
          </button>
        </div>

        <form id="compose-form" style="display:flex; flex-direction:column; gap:10px;">
          <div>
            <label style="display:block; font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:.05em; margin-bottom:4px;">Subject</label>
            <input id="subject" type="text" maxlength="160" required />
          </div>

          <div style="flex:1;">
            <label style="display:block; font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:.05em; margin-bottom:4px;">Message</label>
            <textarea id="body" maxlength="5000" required></textarea>
          </div>

          <button id="send-btn" class="btn" type="submit" disabled>Send</button>

          <div id="compose-error" style="font-size:12px; color:#b91c1c;"></div>
          <div id="compose-success" style="font-size:12px; color:#166534;"></div>

          <div style="font-size:12px; color:#6b7280;">
            Selected: <b><span id="selected-count">0</span></b> • Adults selected: <b><span id="adult-count">0</span></b>
          </div>
        </form>
      </section>

      <!-- MIDDLE: RECIPIENTS -->
      <section>
        <h3>Recipients</h3>

        <div class="tri-toggle">
          <button id="tab-scouts" type="button" class="active">Scouts</button>
          <button id="tab-adults" type="button">Adult Leaders</button>
          <button id="tab-parents" type="button">Parents</button>
        </div>

        <div class="scroll" id="recipients-list">
          <div id="recipients-empty" style="font-size:14px; color:#6b7280;">Loading directory…</div>
        </div>

        <div style="font-size:12px; color:#6b7280; margin-top:10px;">
          Names show as: fullName → first+last → email (only if no name exists).
        </div>
      </section>

      <!-- RIGHT: INBOX -->
      <section>
        <h3>Inbox</h3>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
          <button id="inbox-tab" type="button" class="btn" style="padding:6px 12px; font-size:13px;">Inbox</button>
          <button id="sent-tab" type="button" class="btn" style="padding:6px 12px; font-size:13px; background:rgba(31,78,121,.08); color:#1f4e79; border:1px solid rgba(148,163,184,.7);">
            Sent
          </button>
          <button id="all-tab" type="button" class="btn" style="padding:6px 12px; font-size:13px; background:rgba(31,78,121,.08); color:#1f4e79; border:1px solid rgba(148,163,184,.7);">
            All
          </button>
        </div>

        <div class="scroll">
          <div id="mail-empty" style="font-size:14px; color:#6b7280;">Loading messages…</div>
          <div id="mail-list"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Logic -->
  <script type="module">
    import {
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    import {
      doc,
      getDoc,
      collection,
      query,
      orderBy,
      where,
      onSnapshot,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const auth = window.auth;
    const db = window.db;

    // Header
    const authInfoEl = document.getElementById("auth-info");
    const logoutBtn = document.getElementById("logout-btn");
    const roleBadgeEl = document.getElementById("role-badge");
    const safetyNoteEl = document.getElementById("safety-note");

    // Compose
    const composeForm = document.getElementById("compose-form");
    const subjectEl = document.getElementById("subject");
    const bodyEl = document.getElementById("body");
    const sendBtn = document.getElementById("send-btn");
    const clearSelectedBtn = document.getElementById("clear-selected");
    const clearDraftBtn = document.getElementById("clear-draft");
    const composeErrorEl = document.getElementById("compose-error");
    const composeSuccessEl = document.getElementById("compose-success");
    const selectedCountEl = document.getElementById("selected-count");
    const adultCountEl = document.getElementById("adult-count");

    // Recipients
    const recipientsListEl = document.getElementById("recipients-list");
    const recipientsEmptyEl = document.getElementById("recipients-empty");
    const tabScouts = document.getElementById("tab-scouts");
    const tabAdults = document.getElementById("tab-adults");
    const tabParents = document.getElementById("tab-parents");

    // Mail list
    const mailListEl = document.getElementById("mail-list");
    const mailEmptyEl = document.getElementById("mail-empty");
    const inboxTab = document.getElementById("inbox-tab");
    const sentTab = document.getElementById("sent-tab");
    const allTab = document.getElementById("all-tab");

    // State
    let currentUser = null;
    let currentInfo = null;
    let currentRole = "viewer"; // viewer|admin
    let activeRecipientTab = "scouts"; // scouts|adults|parents
    let activeMailFilter = "inbox"; // inbox|sent|all

    // Directory: expects collection `userDirectory` readable by approved users
    // Each doc id = uid, with fields: fullName?, firstName?, lastName?, email?, accountType?
    const directory = new Map(); // uid -> data
    const selectedUids = new Set();
    const mailMap = new Map(); // id -> message

    let unsubDir = null;
    let unsubInbox = null;
    let unsubSent = null;

    function setStatus(error = "", success = "") {
      composeErrorEl.textContent = error;
      composeSuccessEl.textContent = success;
    }

    function isAdultRole(accountType) {
      const r = (accountType || "").toString().trim().toLowerCase();
      if (!r) return false;
      if (r === "parent") return true;
      if (r === "adult leader") return true;
      if (r.includes("adult")) return true;
      if (r.includes("parent")) return true;
      if (r.includes("leader")) return true;
      return false;
    }

    function senderIsAdult() {
      return isAdultRole(currentInfo?.accountType);
    }

    function displayNameFor(u) {
      const full = (u.fullName || "").toString().trim();
      if (full) return full;

      const first = (u.firstName || "").toString().trim();
      const last = (u.lastName || "").toString().trim();
      const combined = (first + " " + last).trim();
      if (combined) return combined;

      const email = (u.email || "").toString().trim();
      if (email) return email;

      return "(No name)";
    }

    function setActiveRecipientTab(tab) {
      activeRecipientTab = tab;
      tabScouts.classList.toggle("active", tab === "scouts");
      tabAdults.classList.toggle("active", tab === "adults");
      tabParents.classList.toggle("active", tab === "parents");
      renderRecipients();
    }

    function setActiveMailFilter(filter) {
      activeMailFilter = filter;

      // Simple visual: make active one blue, others outlined-ish
      function styleActive(btn, active) {
        if (active) {
          btn.style.background = "var(--blue)";
          btn.style.color = "#fff";
          btn.style.border = "none";
        } else {
          btn.style.background = "rgba(31,78,121,.08)";
          btn.style.color = "var(--blue)";
          btn.style.border = "1px solid rgba(148,163,184,.7)";
        }
      }
      styleActive(inboxTab, filter === "inbox");
      styleActive(sentTab, filter === "sent");
      styleActive(allTab, filter === "all");

      renderMail();
    }

    function updateCountsAndSafety() {
      const sel = Array.from(selectedUids);
      let adultCount = 0;

      sel.forEach((uid) => {
        const u = directory.get(uid);
        if (u && isAdultRole(u.accountType)) adultCount++;
      });

      selectedCountEl.textContent = String(sel.length);
      adultCountEl.textContent = String(adultCount);

      if (!senderIsAdult()) {
        safetyNoteEl.textContent = "Scout rule: include 0 adults OR 2+ adults (no 1-adult messages).";
      } else {
        safetyNoteEl.textContent = "Adult rule: include at least 1 adult recipient.";
      }

      const ok = validateRecipients(true);
      sendBtn.disabled = !ok;
    }

    function validateRecipients(quiet) {
      const toUids = Array.from(selectedUids).filter(uid => uid !== currentUser?.uid);
      if (toUids.length < 1) {
        if (!quiet) setStatus("Select at least one recipient.", "");
        return false;
      }
      if (toUids.length > 20) {
        if (!quiet) setStatus("Max 20 recipients.", "");
        return false;
      }

      let adultCount = 0;
      toUids.forEach((uid) => {
        const u = directory.get(uid);
        if (u && isAdultRole(u.accountType)) adultCount++;
      });

      if (!senderIsAdult()) {
        if (!(adultCount === 0 || adultCount >= 2)) {
          if (!quiet) setStatus("Scout safety rule: 0 adults OR 2+ adults required.", "");
          return false;
        }
      } else {
        if (adultCount < 1) {
          if (!quiet) setStatus("Adult safety rule: must include at least 1 adult recipient.", "");
          return false;
        }
      }

      return true;
    }

    function renderRecipients() {
      recipientsListEl.innerHTML = "";

      const meUid = currentUser?.uid;

      const users = Array.from(directory.entries())
        .map(([uid, data]) => ({ uid, ...data }))
        .filter(u => u.uid !== meUid);

      function isScout(u) {
        return !isAdultRole(u.accountType) && (u.accountType || "").toLowerCase().includes("scout");
      }
      function isParent(u) {
        return (u.accountType || "").toLowerCase().includes("parent");
      }
      function isAdultLeader(u) {
        return (u.accountType || "").toLowerCase().includes("leader");
      }

      let filtered = [];
      if (activeRecipientTab === "scouts") filtered = users.filter(isScout);
      if (activeRecipientTab === "parents") filtered = users.filter(isParent);
      if (activeRecipientTab === "adults") filtered = users.filter(isAdultLeader);

      filtered.sort((a, b) => displayNameFor(a).localeCompare(displayNameFor(b)));

      if (filtered.length === 0) {
        recipientsEmptyEl.style.display = "block";
        recipientsEmptyEl.textContent = "No users in this group yet.";
        recipientsListEl.appendChild(recipientsEmptyEl);
        updateCountsAndSafety();
        return;
      }

      filtered.forEach((u) => {
        const row = document.createElement("div");
        row.className = "user-row";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = selectedUids.has(u.uid);
        cb.addEventListener("change", () => {
          if (cb.checked) selectedUids.add(u.uid);
          else selectedUids.delete(u.uid);
          setStatus("", "");
          updateCountsAndSafety();
        });

        const label = document.createElement("div");
        label.style.flex = "1";
        label.style.minWidth = "0";
        label.textContent = displayNameFor(u);

        row.appendChild(cb);
        row.appendChild(label);

        recipientsListEl.appendChild(row);
      });

      updateCountsAndSafety();
    }

    function escapeHtml(str) {
      return (str || "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function formatTime(ts) {
      if (!ts) return "";
      try {
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleString(undefined, {
          year: "numeric", month: "short", day: "numeric",
          hour: "2-digit", minute: "2-digit"
        });
      } catch {
        return "";
      }
    }

    function renderMail() {
      mailListEl.innerHTML = "";

      const items = Array.from(mailMap.entries())
        .map(([id, m]) => ({ id, ...m }))
        .sort((a, b) => {
          const at = a.createdAt?.seconds ? a.createdAt.seconds : 0;
          const bt = b.createdAt?.seconds ? b.createdAt.seconds : 0;
          return bt - at;
        });

      const filtered = items.filter((m) => {
        const isSentByMe = m.fromUid === currentUser.uid;
        const isToMe = Array.isArray(m.toUids) && m.toUids.includes(currentUser.uid);

        if (activeMailFilter === "inbox") return isToMe;
        if (activeMailFilter === "sent") return isSentByMe;
        return isToMe || isSentByMe;
      });

      if (filtered.length === 0) {
        mailEmptyEl.style.display = "block";
        mailEmptyEl.textContent = "No messages to show.";
        return;
      }
      mailEmptyEl.style.display = "none";

      filtered.forEach((m) => {
        const card = document.createElement("div");
        card.className = "mail-item";

        const fromInfo = directory.get(m.fromUid) || {};
        const fromName = (m.fromUid === currentUser.uid) ? "You" : displayNameFor(fromInfo);

        const subject = m.subject || "(No subject)";
        const meta = `From ${fromName}${m.createdAt ? " • " + formatTime(m.createdAt) : ""}`;
        const body = m.body || "";

        card.innerHTML = `
          <div class="mail-subject">${escapeHtml(subject)}</div>
          <div class="mail-meta">${escapeHtml(meta)}</div>
          <div style="margin-top:6px; font-size:13px; white-space:pre-wrap; overflow-wrap:break-word;">
            ${escapeHtml(body)}
          </div>
        `;

        mailListEl.appendChild(card);
      });
    }

    function startDirectoryListener() {
      if (unsubDir) unsubDir();
      directory.clear();

      // IMPORTANT: This expects a public-to-approved directory collection.
      unsubDir = onSnapshot(
        query(collection(db, "userDirectory"), orderBy("fullName", "asc")),
        (snapshot) => {
          directory.clear();
          snapshot.forEach((docSnap) => {
            directory.set(docSnap.id, docSnap.data() || {});
          });
          renderRecipients();
          renderMail();
        },
        (error) => {
          console.error("Directory listener error:", error);
          recipientsListEl.innerHTML = "";
          recipientsEmptyEl.style.display = "block";
          recipientsEmptyEl.textContent = "Directory not available yet (userDirectory).";
          recipientsListEl.appendChild(recipientsEmptyEl);
          updateCountsAndSafety();
        }
      );
    }

    function startMailListeners() {
      if (unsubInbox) unsubInbox();
      if (unsubSent) unsubSent();

      mailMap.clear();
      renderMail();
      mailEmptyEl.style.display = "block";
      mailEmptyEl.textContent = "Loading messages…";

      unsubInbox = onSnapshot(
        query(
          collection(db, "mailOutbox"),
          where("toUids", "array-contains", currentUser.uid),
          orderBy("createdAt", "desc")
        ),
        (snap) => {
          snap.docChanges().forEach((chg) => {
            if (chg.type === "removed") mailMap.delete(chg.doc.id);
            else mailMap.set(chg.doc.id, chg.doc.data());
          });
          renderMail();
        },
        (err) => {
          console.error("Inbox listener error:", err);
          mailEmptyEl.style.display = "block";
          mailEmptyEl.textContent = "Error loading inbox.";
        }
      );

      unsubSent = onSnapshot(
        query(
          collection(db, "mailOutbox"),
          where("fromUid", "==", currentUser.uid),
          orderBy("createdAt", "desc")
        ),
        (snap) => {
          snap.docChanges().forEach((chg) => {
            if (chg.type === "removed") mailMap.delete(chg.doc.id);
            else mailMap.set(chg.doc.id, chg.doc.data());
          });
          renderMail();
        },
        (err) => {
          console.error("Sent listener error:", err);
        }
      );
    }

    async function handleAuth(user) {
      if (!user) {
        window.location.href = "/";
        return;
      }

      currentUser = user;
      authInfoEl.textContent = "Signed in as " + (user.email || user.uid);

      const infoRef = doc(db, "accountInfo", user.uid);
      const infoSnap = await getDoc(infoRef);

      if (!infoSnap.exists()) {
        window.location.href = "/under-review/";
        return;
      }

      const info = infoSnap.data() || {};
      const role = info.authRole;

      if (role !== "admin" && role !== "viewer") {
        window.location.href = "/under-review/";
        return;
      }

      currentInfo = info;
      currentRole = role;
      roleBadgeEl.textContent = role;

      startDirectoryListener();
      startMailListeners();
      updateCountsAndSafety();
    }

    onAuthStateChanged(auth, (user) => {
      handleAuth(user).catch((e) => {
        console.error("Auth handler error:", e);
        window.location.href = "/home";
      });
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "/";
    });

    // Tabs
    tabScouts.addEventListener("click", () => setActiveRecipientTab("scouts"));
    tabAdults.addEventListener("click", () => setActiveRecipientTab("adults"));
    tabParents.addEventListener("click", () => setActiveRecipientTab("parents"));

    inboxTab.addEventListener("click", () => setActiveMailFilter("inbox"));
    sentTab.addEventListener("click", () => setActiveMailFilter("sent"));
    allTab.addEventListener("click", () => setActiveMailFilter("all"));

    // Clear buttons
    clearSelectedBtn.addEventListener("click", () => {
      selectedUids.clear();
      setStatus("", "");
      renderRecipients();
    });

    clearDraftBtn.addEventListener("click", () => {
      subjectEl.value = "";
      bodyEl.value = "";
      setStatus("", "");
      updateCountsAndSafety();
    });

    // Send
    composeForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      setStatus("", "");

      if (!validateRecipients(false)) return;

      const subject = (subjectEl.value || "").toString().trim();
      const body = (bodyEl.value || "").toString().trim();
      if (!subject) return setStatus("Subject is required.", "");
      if (!body) return setStatus("Message is required.", "");

      const toUids = Array.from(selectedUids).filter(uid => uid !== currentUser.uid);

      sendBtn.disabled = true;
      sendBtn.textContent = "Sending…";

      try {
        await addDoc(collection(db, "mailOutbox"), {
          fromUid: currentUser.uid,
          toUids,
          subject,
          body,
          status: "queued",
          createdAt: serverTimestamp()
        });

        setStatus("", "Queued. It will send shortly.");
        subjectEl.value = "";
        bodyEl.value = "";
        selectedUids.clear();
        renderRecipients();
      } catch (err) {
        console.error(err);
        setStatus(err?.message || "Error sending message.", "");
      } finally {
        sendBtn.textContent = "Send";
        updateCountsAndSafety();
      }
    });

    // Initial tab styles
    setActiveRecipientTab("scouts");
    setActiveMailFilter("inbox");
  <script type="module">
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    collection,
    doc,
    getDoc,
    addDoc,
    query,
    where,
    orderBy,
    onSnapshot,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const auth = window.auth;
  const db = window.db;

  // Header
  const authInfoEl = document.getElementById("auth-info");
  const logoutBtn = document.getElementById("logout-btn");
  const roleBadgeEl = document.getElementById("role-badge");
  const safetyNoteEl = document.getElementById("safety-note");

  // Compose
  const composeForm = document.getElementById("compose-form");
  const subjectEl = document.getElementById("subject");
  const bodyEl = document.getElementById("body");
  const sendBtn = document.getElementById("send-btn");
  const clearSelectedBtn = document.getElementById("clear-selected");
  const clearDraftBtn = document.getElementById("clear-draft");
  const composeErrorEl = document.getElementById("compose-error");
  const composeSuccessEl = document.getElementById("compose-success");
  const selectedCountEl = document.getElementById("selected-count");
  const adultCountEl = document.getElementById("adult-count");

  // Recipients
  const recipientsListEl = document.getElementById("recipients-list");
  const recipientsEmptyEl = document.getElementById("recipients-empty");
  const tabScouts = document.getElementById("tab-scouts");
  const tabAdults = document.getElementById("tab-adults");
  const tabParents = document.getElementById("tab-parents");

  // Mail list
  const mailListEl = document.getElementById("mail-list");
  const mailEmptyEl = document.getElementById("mail-empty");
  const inboxTab = document.getElementById("inbox-tab");
  const sentTab = document.getElementById("sent-tab");
  const allTab = document.getElementById("all-tab");

  // State
  let currentUser = null;
  let myInfo = null;
  let myAuthRole = "viewer";
  let myAccountType = ""; // from accountInfo.accountType
  let activeRecipientTab = "scouts"; // scouts|adults|parents
  let activeMailFilter = "inbox"; // inbox|sent|all

  const directory = new Map(); // uid -> userDirectory doc data
  const selectedUids = new Set();

  const mailMap = new Map(); // docId -> outbox doc data
  let unsubDir = null;
  let unsubInbox = null;
  let unsubSent = null;

  function setStatus(err = "", ok = "") {
    composeErrorEl.textContent = err;
    composeSuccessEl.textContent = ok;
  }

  function normType(t) {
    return (t || "").toString().trim().toLowerCase();
  }

  function isScoutType(t) {
    return normType(t).includes("scout");
  }

  function isParentType(t) {
    return normType(t).includes("parent");
  }

  function isLeaderType(t) {
    return normType(t).includes("leader");
  }

  function isAdultType(t) {
    const nt = normType(t);
    return nt.includes("parent") || nt.includes("leader") || nt.includes("adult");
  }

  function senderIsAdult() {
    return isAdultType(myAccountType);
  }

  function displayNameFor(u) {
    const full = (u.fullName || "").toString().trim();
    if (full) return full;

    const first = (u.firstName || "").toString().trim();
    const last = (u.lastName || "").toString().trim();
    const combined = (first + " " + last).trim();
    if (combined) return combined;

    const email = (u.email || "").toString().trim();
    return email || "(No name)";
  }

  function escapeHtml(str) {
    return (str || "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function formatTime(ts) {
    if (!ts) return "";
    try {
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString(undefined, {
        year: "numeric", month: "short", day: "numeric",
        hour: "2-digit", minute: "2-digit"
      });
    } catch {
      return "";
    }
  }

  function setActiveRecipientTab(tab) {
    activeRecipientTab = tab;
    tabScouts.classList.toggle("active", tab === "scouts");
    tabAdults.classList.toggle("active", tab === "adults");
    tabParents.classList.toggle("active", tab === "parents");
    renderRecipients();
  }

  function setActiveMailFilter(filter) {
    activeMailFilter = filter;

    function styleBtn(btn, active) {
      if (active) {
        btn.style.background = "var(--blue)";
        btn.style.color = "#fff";
        btn.style.border = "none";
      } else {
        btn.style.background = "rgba(31,78,121,.08)";
        btn.style.color = "var(--blue)";
        btn.style.border = "1px solid rgba(148,163,184,.7)";
      }
    }

    styleBtn(inboxTab, filter === "inbox");
    styleBtn(sentTab, filter === "sent");
    styleBtn(allTab, filter === "all");

    renderMail();
  }

  function updateCountsAndSafety() {
    const sel = Array.from(selectedUids);
    let adultCount = 0;

    sel.forEach((uid) => {
      const u = directory.get(uid);
      if (u && isAdultType(u.accountType)) adultCount++;
    });

    selectedCountEl.textContent = String(sel.length);
    adultCountEl.textContent = String(adultCount);

    if (!senderIsAdult()) {
      safetyNoteEl.textContent = "Scout rule: include 0 adults OR 2+ adults (no 1-adult messages).";
    } else {
      safetyNoteEl.textContent = "Adult rule: include at least 1 adult recipient.";
    }

    sendBtn.disabled = !validateRecipients(true);
  }

  function validateRecipients(quiet) {
    const toUids = Array.from(selectedUids).filter(uid => uid !== currentUser?.uid);

    if (toUids.length < 1) {
      if (!quiet) setStatus("Select at least one recipient.", "");
      return false;
    }
    if (toUids.length > 20) {
      if (!quiet) setStatus("Max 20 recipients.", "");
      return false;
    }

    let adultCount = 0;
    toUids.forEach((uid) => {
      const u = directory.get(uid);
      if (u && isAdultType(u.accountType)) adultCount++;
    });

    if (!senderIsAdult()) {
      if (!(adultCount === 0 || adultCount >= 2)) {
        if (!quiet) setStatus("Scout safety rule: 0 adults OR 2+ adults required.", "");
        return false;
      }
    } else {
      if (adultCount < 1) {
        if (!quiet) setStatus("Adult safety rule: must include at least 1 adult recipient.", "");
        return false;
      }
    }

    return true;
  }

  function renderRecipients() {
    recipientsListEl.innerHTML = "";

    const meUid = currentUser?.uid;

    const users = Array.from(directory.entries())
      .map(([uid, data]) => ({ uid, ...data }))
      .filter(u => u.uid !== meUid);

    let filtered = [];
    if (activeRecipientTab === "scouts") {
      filtered = users.filter(u => isScoutType(u.accountType));
    } else if (activeRecipientTab === "parents") {
      filtered = users.filter(u => isParentType(u.accountType));
    } else if (activeRecipientTab === "adults") {
      filtered = users.filter(u => isLeaderType(u.accountType));
    }

    filtered.sort((a, b) => displayNameFor(a).localeCompare(displayNameFor(b)));

    if (filtered.length === 0) {
      recipientsEmptyEl.style.display = "block";
      recipientsEmptyEl.textContent = "No users in this group.";
      recipientsListEl.appendChild(recipientsEmptyEl);
      updateCountsAndSafety();
      return;
    }

    recipientsEmptyEl.style.display = "none";

    filtered.forEach((u) => {
      const row = document.createElement("div");
      row.className = "user-row";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selectedUids.has(u.uid);
      cb.addEventListener("change", () => {
        if (cb.checked) selectedUids.add(u.uid);
        else selectedUids.delete(u.uid);
        setStatus("", "");
        updateCountsAndSafety();
      });

      const label = document.createElement("div");
      label.style.flex = "1";
      label.style.minWidth = "0";
      label.textContent = displayNameFor(u);

      row.appendChild(cb);
      row.appendChild(label);
      recipientsListEl.appendChild(row);
    });

    updateCountsAndSafety();
  }

  function renderMail() {
    mailListEl.innerHTML = "";

    const items = Array.from(mailMap.entries())
      .map(([id, m]) => ({ id, ...m }))
      .sort((a, b) => {
        const at = a.createdAt?.seconds ? a.createdAt.seconds : 0;
        const bt = b.createdAt?.seconds ? b.createdAt.seconds : 0;
        return bt - at;
      });

    const filtered = items.filter((m) => {
      const sentByMe = m.fromUid === currentUser.uid;
      const toMe = Array.isArray(m.toUids) && m.toUids.includes(currentUser.uid);

      if (activeMailFilter === "inbox") return toMe;
      if (activeMailFilter === "sent") return sentByMe;
      return toMe || sentByMe;
    });

    if (filtered.length === 0) {
      mailEmptyEl.style.display = "block";
      mailEmptyEl.textContent = "No messages to show.";
      return;
    }

    mailEmptyEl.style.display = "none";

    filtered.forEach((m) => {
      const card = document.createElement("div");
      card.className = "mail-item";

      const fromInfo = directory.get(m.fromUid) || {};
      const fromName = (m.fromUid === currentUser.uid) ? "You" : displayNameFor(fromInfo);
      const subject = m.subject || "(No subject)";
      const meta = `From ${fromName}${m.createdAt ? " • " + formatTime(m.createdAt) : ""}`;
      const body = m.body || "";

      card.innerHTML = `
        <div class="mail-subject">${escapeHtml(subject)}</div>
        <div class="mail-meta">${escapeHtml(meta)}</div>
        <div style="margin-top:6px; font-size:13px; white-space:pre-wrap; overflow-wrap:break-word;">
          ${escapeHtml(body)}
        </div>
      `;

      mailListEl.appendChild(card);
    });
  }

  function startDirectoryListener() {
    if (unsubDir) unsubDir();
    directory.clear();

    unsubDir = onSnapshot(
      collection(db, "userDirectory"),
      (snapshot) => {
        directory.clear();
        snapshot.forEach((docSnap) => {
          directory.set(docSnap.id, docSnap.data() || {});
        });
        renderRecipients();
        renderMail();
      },
      (error) => {
        console.error("userDirectory listener error:", error);
        recipientsListEl.innerHTML = "";
        recipientsEmptyEl.style.display = "block";
        recipientsEmptyEl.textContent = "Directory not available.";
        recipientsListEl.appendChild(recipientsEmptyEl);
        updateCountsAndSafety();
      }
    );
  }

  function startMailListeners() {
    if (unsubInbox) unsubInbox();
    if (unsubSent) unsubSent();

    mailMap.clear();
    renderMail();
    mailEmptyEl.style.display = "block";
    mailEmptyEl.textContent = "Loading messages…";

    // Inbox: messages addressed to me
    unsubInbox = onSnapshot(
      query(
        collection(db, "mailOutbox"),
        where("toUids", "array-contains", currentUser.uid),
        orderBy("createdAt", "desc")
      ),
      (snap) => {
        snap.docChanges().forEach((chg) => {
          if (chg.type === "removed") mailMap.delete(chg.doc.id);
          else mailMap.set(chg.doc.id, chg.doc.data());
        });
        renderMail();
      },
      (err) => {
        console.error("Inbox listener error:", err);
        mailEmptyEl.style.display = "block";
        mailEmptyEl.textContent = "Error loading inbox.";
      }
    );

    // Sent: messages sent by me
    unsubSent = onSnapshot(
      query(
        collection(db, "mailOutbox"),
        where("fromUid", "==", currentUser.uid),
        orderBy("createdAt", "desc")
      ),
      (snap) => {
        snap.docChanges().forEach((chg) => {
          if (chg.type === "removed") mailMap.delete(chg.doc.id);
          else mailMap.set(chg.doc.id, chg.doc.data());
        });
        renderMail();
      },
      (err) => {
        console.error("Sent listener error:", err);
      }
    );
  }

  async function handleAuth(user) {
    if (!user) {
      window.location.href = "/";
      return;
    }

    currentUser = user;
    authInfoEl.textContent = "Signed in as " + (user.email || user.uid);

    const infoSnap = await getDoc(doc(db, "accountInfo", user.uid));
    if (!infoSnap.exists()) {
      window.location.href = "/under-review/";
      return;
    }

    const info = infoSnap.data() || {};
    if (!["admin", "viewer"].includes(info.authRole)) {
      window.location.href = "/under-review/";
      return;
    }

    myInfo = info;
    myAuthRole = info.authRole;
    myAccountType = info.accountType || info.roleType || "";

    roleBadgeEl.textContent = myAuthRole;

    startDirectoryListener();
    startMailListeners();
    updateCountsAndSafety();
  }

  // Auth
  onAuthStateChanged(auth, (user) => {
    handleAuth(user).catch((e) => {
      console.error("Auth handler error:", e);
      window.location.href = "/home";
    });
  });

  // Logout
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "/";
  });

  // Recipient tabs
  tabScouts.addEventListener("click", () => setActiveRecipientTab("scouts"));
  tabAdults.addEventListener("click", () => setActiveRecipientTab("adults"));
  tabParents.addEventListener("click", () => setActiveRecipientTab("parents"));

  // Mail tabs
  inboxTab.addEventListener("click", () => setActiveMailFilter("inbox"));
  sentTab.addEventListener("click", () => setActiveMailFilter("sent"));
  allTab.addEventListener("click", () => setActiveMailFilter("all"));

  // Clear buttons
  clearSelectedBtn.addEventListener("click", () => {
    selectedUids.clear();
    setStatus("", "");
    renderRecipients();
  });

  clearDraftBtn.addEventListener("click", () => {
    subjectEl.value = "";
    bodyEl.value = "";
    setStatus("", "");
    updateCountsAndSafety();
  });

  // Send
  composeForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    setStatus("", "");

    if (!validateRecipients(false)) return;

    const subject = (subjectEl.value || "").toString().trim();
    const body = (bodyEl.value || "").toString().trim();
    if (!subject) return setStatus("Subject is required.", "");
    if (!body) return setStatus("Message is required.", "");

    const toUids = Array.from(selectedUids).filter(uid => uid !== currentUser.uid);

    sendBtn.disabled = true;
    sendBtn.textContent = "Sending…";

    try {
      await addDoc(collection(db, "mailOutbox"), {
        fromUid: currentUser.uid,
        toUids,
        subject,
        body,
        senderAccountType: myAccountType,
        status: "queued",
        createdAt: serverTimestamp()
      });

      setStatus("", "Queued. It will send shortly.");
      subjectEl.value = "";
      bodyEl.value = "";
      selectedUids.clear();
      renderRecipients();
    } catch (err) {
      console.error(err);
      setStatus(err?.message || "Error sending message.", "");
    } finally {
      sendBtn.textContent = "Send";
      updateCountsAndSafety();
    }
  });

  // Initial UI state
  setActiveRecipientTab("scouts");
  setActiveMailFilter("inbox");
</script>
</body>
</html>
