<!-- /public/patrols/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Patrols — Troop 248</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/bsafavicon.ico">

  <style>
    :root {
      --red: #b22222;
      --blue: #1f4e79;
      --tan: #f4eee3;
      --white: #ffffff;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --radius-lg: 16px;
      --radius-pill: 999px;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.06);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #d2cab6;
      color: var(--text-main);
      min-height: 100vh;
    }

    header {
      background: linear-gradient(120deg, #b22222, #ffffff, #1f4e79);
      color: var(--white);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h2 {
      margin: 0;
      font-size: 19px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h2::before { content: "★"; font-size: 18px; }

    .troop-home-link {
      text-decoration: none;
      color: inherit;
      display: inline-flex;
      align-items: center;
    }
    .troop-home-link:hover h2 { opacity: 0.9; text-decoration: underline; }

    nav {
      display: flex;
      gap: 12px;
      font-size: 13px;
      text-transform: uppercase;
    }

    nav a {
      color: #1f4e79;
      font-weight: bold;
      text-decoration: none;
      padding: 6px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(4px);
      opacity: 0.9;
    }

    nav a:hover { opacity: 1; background: rgba(255, 255, 255, 0.12); }

    #auth-bar {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 13px;
    }

    #logout-btn {
      padding: 5px 12px;
      font-size: 13px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.7);
      background: rgba(255, 255, 255, 0.1);
      color: var(--white);
      cursor: pointer;
    }

    #logout-btn:hover { background: rgba(255, 255, 255, 0.2); }

    main {
      padding: 24px 16px 40px;
      max-width: 960px;
      margin: 0 auto;
    }

    .welcome-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--radius-lg);
      padding: 18px 18px 10px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      flex-wrap: wrap;
    }

    .welcome-card h3 {
      margin: 0 0 4px;
      font-size: 18px;
    }

    .welcome-card p {
      margin: 0;
      font-size: 14px;
      color: var(--text-muted);
    }

    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: var(--radius-pill);
      background: rgba(148, 163, 184, 0.2);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.07em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .badge.admin {
      background: rgba(240, 180, 41, 0.16);
      color: #92400e;
      border: 1px solid rgba(245, 158, 11, 0.6);
    }

    section {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--radius-lg);
      padding: 18px 18px 14px;
      margin-bottom: 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    section h2 {
      margin-top: 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    section h2::before { content: "▸"; font-size: 14px; color: var(--blue); }

    .admin-only { display: none; }

    form {
      margin-bottom: 10px;
      padding: 10px 10px 8px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px dashed rgba(148, 163, 184, 0.8);
    }

    form h3 {
      margin: 0 0 8px;
      font-size: 15px;
      color: var(--blue);
    }

    .field { margin-bottom: 8px; }

    .field label {
      display: block;
      font-size: 12px;
      margin-bottom: 3px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .05em;
    }

    .field input, .field textarea, .field select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 14px;
    }

    .field input:focus, .field textarea:focus, .field select:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 2px rgba(31,78,121,.1);
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 720px) {
      .field-row { grid-template-columns: minmax(0, 1fr); }
    }

    button {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: var(--radius-pill);
      border: none;
      cursor: pointer;
      font-weight: 700;
      background: var(--blue);
      color: var(--white);
    }
    button:hover { opacity: .96; }

    .btn-secondary { background: var(--red); }

    .small-help {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .ok { color: #166534; font-weight: 700; }
    .bad { color: #b91c1c; font-weight: 700; }

    /* Patrol list */
    .patrol-stack {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }

    details.patrol {
      border-radius: 14px;
      border: 1px solid rgba(209,213,219,.9);
      background: #f9fafb;
      box-shadow: 0 4px 12px rgba(0,0,0,.04);
      overflow: hidden;
    }

    summary.patrol-summary {
      list-style: none;
      cursor: pointer;
      padding: 12px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      user-select: none;
    }

    summary.patrol-summary::-webkit-details-marker { display:none; }

    .patrol-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .patrol-name {
      font-weight: 900;
      font-size: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      font-weight: 800;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      background: rgba(31,78,121,.08);
      color: var(--blue);
      border: 1px solid rgba(31,78,121,.18);
      white-space: nowrap;
    }

    .pill.gray {
      background: rgba(148, 163, 184, 0.2);
      color: var(--text-muted);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .patrol-body {
      padding: 10px 12px 12px;
      border-top: 1px solid rgba(0,0,0,.06);
    }

    .scout-list {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    @media (max-width: 720px) {
      .scout-list { grid-template-columns: minmax(0,1fr); }
    }

    .scout-card {
      border-radius: 14px;
      padding: 10px 10px;
      border: 1px solid rgba(209,213,219,.9);
      background: #fff;
    }

    .scout-name { font-weight: 900; font-size: 14px; margin: 0; }
    .scout-meta { margin: 2px 0 0; font-size: 12px; color: var(--text-muted); word-break: break-word; }

    .empty-text { font-size: 14px; color: var(--text-muted); margin-top: 6px; }

    /* Assign section */
    .assign-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      align-items: end;
    }
    .assign-grid .col6 { grid-column: span 6; }
    .assign-grid .col12 { grid-column: span 12; }

    @media (max-width: 720px) {
      .assign-grid .col6 { grid-column: span 12; }
    }

    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      nav { width: 100%; justify-content: flex-start; flex-wrap: wrap; }
    }
  </style>
</head>

<body>
  <header>
    <div>
      <a href="/home" class="troop-home-link">
        <h2>Troop 248</h2>
      </a>
    </div>

    <nav>
      <a href="/home">Home</a>
      <a href="/calendar">Calendar</a>
      <a href="/documents">Documents</a>
      <a href="/scoutmaster">SM Blog</a>
      <a href="/spl">SPL Blog</a>
      <a href="/useful-links">Useful Links</a>
      <a href="/events">Events</a>
      <a href="/mail">Mail</a>
      <a href="/roster">Roster</a>
      <a href="/patrols">Patrols</a>
    </nav>

    <div id="auth-bar">
      <div id="auth-info">Signed in as …</div>
      <button id="logout-btn" type="button">Log Out</button>
    </div>
  </header>

  <main>
    <div class="welcome-card">
      <div>
        <h3>Patrols</h3>
        <p>Manage patrols and assign Scouts. (Unassigned is shown at the bottom.)</p>
      </div>
      <div id="role-badge-container">
        <span class="badge">Viewer</span>
      </div>
    </div>

    <!-- 1) Create Patrol -->
    <section class="admin-only" id="create-section">
      <h2>Create Patrol</h2>
      <form id="create-patrol-form">
        <h3>New Patrol</h3>

        <div class="field">
          <label for="patrol-name">Patrol Name</label>
          <input id="patrol-name" type="text" placeholder="Eagle Patrol" required />
        </div>

        <div class="field">
          <label for="patrol-tags">Tags (comma separated)</label>
          <input id="patrol-tags" type="text" placeholder="older-scouts, high-adventure" />
        </div>

        <button type="submit">Create Patrol</button>
        <div id="create-msg" class="small-help"></div>
      </form>
      <div class="small-help">
        Patrols are stored in Firestore collection <code>patrols</code>. Scouts store their assigned patrol name in <code>accountInfo/{uid}.patrol</code>.
      </div>
    </section>

    <!-- 2) All Patrols -->
    <section>
      <h2>All Patrols</h2>
      <div class="small-help">
        Expand a patrol to see Scouts assigned to it.
      </div>

      <div id="patrolsWrap" class="patrol-stack"></div>
      <div id="patrolsEmpty" class="empty-text" style="display:none;">No patrols yet.</div>
    </section>

    <!-- 3) Assign Scouts -->
    <section class="admin-only" id="assign-section">
      <h2>Assign Scouts</h2>

      <div class="assign-grid">
        <div class="field col6">
          <label for="assign-scout">Select Scout</label>
          <select id="assign-scout"></select>
        </div>

        <div class="field col6">
          <label for="assign-patrol">Select Patrol</label>
          <select id="assign-patrol"></select>
        </div>

        <div class="col12">
          <button id="assign-btn" type="button">Assign</button>
          <div id="assign-msg" class="small-help"></div>
        </div>
      </div>

      <div class="small-help">
        Tip: Choose “Unassigned” to clear a Scout’s patrol.
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      setDoc,
      updateDoc,
      onSnapshot,
      query,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD5qUHa2JuQ3iI7U3DrX7JDyhx76PGzhxM",
      authDomain: "troop-248.firebaseapp.com",
      projectId: "troop-248",
      storageBucket: "troop-248.firebasestorage.app",
      messagingSenderId: "925363875752",
      appId: "1:925363875752:web:0b001c1a7a09fb8232f79d",
      measurementId: "G-NY75GX5TBH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authInfoEl = document.getElementById("auth-info");
    const logoutBtn = document.getElementById("logout-btn");
    const roleBadgeContainer = document.getElementById("role-badge-container");

    const adminOnlyEls = document.getElementsByClassName("admin-only");

    const createForm = document.getElementById("create-patrol-form");
    const patrolNameInput = document.getElementById("patrol-name");
    const patrolTagsInput = document.getElementById("patrol-tags");
    const createMsg = document.getElementById("create-msg");

    const patrolsWrap = document.getElementById("patrolsWrap");
    const patrolsEmpty = document.getElementById("patrolsEmpty");

    const assignScoutSel = document.getElementById("assign-scout");
    const assignPatrolSel = document.getElementById("assign-patrol");
    const assignBtn = document.getElementById("assign-btn");
    const assignMsg = document.getElementById("assign-msg");

    let currentUser = null;
    let currentIsAdmin = false;

    // live data
    let patrols = [];     // [{id,name,tags}]
    let scouts = [];      // [{uid, fullName, email, accountType, patrol}]

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalizeRole(authRole){
      const r = (authRole || "").toString().trim().toLowerCase();
      if (r === "admin") return "admin";
      if (r === "viewer") return "viewer";
      return "pending";
    }

    function slugify(text) {
      return String(text || "")
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
    }

    function parseTags(s) {
      const raw = String(s || "").trim();
      if (!raw) return [];
      return raw
        .split(",")
        .map(t => t.trim())
        .filter(Boolean)
        .slice(0, 12);
    }

    function setRoleUI(role){
      if (role === "admin") {
        roleBadgeContainer.innerHTML = `<span class="badge admin">Admin</span>`;
      } else {
        roleBadgeContainer.innerHTML = `<span class="badge">Viewer</span>`;
      }
    }

    function showAdminOnly() {
      for (let i = 0; i < adminOnlyEls.length; i++) {
        adminOnlyEls[i].style.display = currentIsAdmin ? "block" : "none";
      }
    }

    function groupScoutsByPatrol() {
      const map = new Map(); // patrolName -> scouts[]
      scouts.forEach(s => {
        const p = (s.patrol || "").trim();
        if (!map.has(p)) map.set(p, []);
        map.get(p).push(s);
      });

      // sort scouts by name inside each group
      for (const [k, arr] of map.entries()) {
        arr.sort((a,b) => (a.fullName || "").localeCompare(b.fullName || ""));
      }
      return map;
    }

    function renderPatrols() {
      patrolsWrap.innerHTML = "";
      patrolsEmpty.style.display = patrols.length === 0 ? "block" : "none";

      const byPatrol = groupScoutsByPatrol();

      // Build patrol order: all patrol docs first (alphabetical already), then Unassigned at bottom
      const patrolNames = patrols.map(p => (p.name || "").trim()).filter(Boolean);
      const unassigned = byPatrol.get("") || [];

      // Render each patrol doc
      patrols.forEach(p => {
        const name = (p.name || "").trim();
        const tags = Array.isArray(p.tags) ? p.tags : [];
        const members = byPatrol.get(name) || [];

        const details = document.createElement("details");
        details.className = "patrol";

        const tagsHtml = tags.length
          ? `<span class="pill">${escapeHtml(tags[0])}${tags.length > 1 ? ` +${tags.length-1}` : ""}</span>`
          : `<span class="pill gray">No tags</span>`;

        details.innerHTML = `
          <summary class="patrol-summary">
            <div class="patrol-left">
              <div class="patrol-name">${escapeHtml(name || "Unnamed Patrol")}</div>
              ${tagsHtml}
            </div>
            <span class="badge">${members.length} Scout${members.length === 1 ? "" : "s"}</span>
          </summary>
          <div class="patrol-body">
            ${tags.length ? `<div class="small-help">Tags: <b>${escapeHtml(tags.join(", "))}</b></div>` : ""}
            ${members.length ? `
              <div class="scout-list">
                ${members.map(s => `
                  <div class="scout-card">
                    <p class="scout-name">${escapeHtml(s.fullName || "Unnamed")}</p>
                    <p class="scout-meta">${escapeHtml(s.email || "")}</p>
                  </div>
                `).join("")}
              </div>
            ` : `<div class="empty-text">No Scouts assigned to this patrol.</div>`}
          </div>
        `;

        patrolsWrap.appendChild(details);
      });

      // Render UNASSIGNED LAST
      const unDetails = document.createElement("details");
      unDetails.className = "patrol";
      unDetails.innerHTML = `
        <summary class="patrol-summary">
          <div class="patrol-left">
            <div class="patrol-name">Unassigned</div>
            <span class="pill gray">No patrol</span>
          </div>
          <span class="badge">${unassigned.length} Scout${unassigned.length === 1 ? "" : "s"}</span>
        </summary>
        <div class="patrol-body">
          ${unassigned.length ? `
            <div class="scout-list">
              ${unassigned.map(s => `
                <div class="scout-card">
                  <p class="scout-name">${escapeHtml(s.fullName || "Unnamed")}</p>
                  <p class="scout-meta">${escapeHtml(s.email || "")}</p>
                </div>
              `).join("")}
            </div>
          ` : `<div class="empty-text">No unassigned Scouts.</div>`}
        </div>
      `;
      patrolsWrap.appendChild(unDetails);

      // Keep Assign dropdowns synced
      if (currentIsAdmin) {
        // Patrol dropdown: Unassigned + patrols
        const patrolOptions = [
          { value: "", label: "Unassigned" },
          ...patrols.map(p => ({ value: (p.name || "").trim(), label: (p.name || "").trim() })).filter(x => x.value)
        ];

        assignPatrolSel.innerHTML = patrolOptions
          .map(o => `<option value="${escapeHtml(o.value)}">${escapeHtml(o.label)}</option>`)
          .join("");

        // Scout dropdown: only scouts
        assignScoutSel.innerHTML = scouts
          .slice()
          .sort((a,b) => (a.fullName || "").localeCompare(b.fullName || ""))
          .map(s => {
            const label = `${s.fullName || "Unnamed"}${s.email ? " — " + s.email : ""}${(s.patrol || "") ? " (" + s.patrol + ")" : " (Unassigned)"}`;
            return `<option value="${escapeHtml(s.uid)}">${escapeHtml(label)}</option>`;
          })
          .join("");
      }
    }

    async function getMyRole(uid){
      const snap = await getDoc(doc(db, "accountInfo", uid));
      if (!snap.exists()) return "pending";
      return normalizeRole((snap.data() || {}).authRole);
    }

    function guardOrRedirect(user, role){
      if (!user) { window.location.replace("/"); return false; }
      if (role !== "admin" && role !== "viewer") { window.location.replace("/under-review/"); return false; }
      return true;
    }

    // --- Admin actions ---
    async function createPatrol(e) {
      e.preventDefault();
      createMsg.textContent = "";
      createMsg.className = "small-help";

      const name = patrolNameInput.value.trim();
      const tags = parseTags(patrolTagsInput.value);

      if (!name) {
        createMsg.textContent = "Please enter a patrol name.";
        createMsg.classList.add("bad");
        return;
      }

      const id = slugify(name) || ("patrol-" + Math.random().toString(36).slice(2,6));

      try {
        // store name (display), tags array
        await setDoc(doc(db, "patrols", id), {
          name,
          tags,
          createdAt: serverTimestamp(),
          createdBy: currentUser ? currentUser.uid : null
        }, { merge: false });

        patrolNameInput.value = "";
        patrolTagsInput.value = "";

        createMsg.textContent = "Patrol created.";
        createMsg.classList.add("ok");
      } catch (err) {
        console.error(err);
        createMsg.textContent = err?.message || "Error creating patrol.";
        createMsg.classList.add("bad");
      }
    }

    async function assignScout() {
      assignMsg.textContent = "";
      assignMsg.className = "small-help";

      const uid = assignScoutSel.value;
      const patrolName = assignPatrolSel.value; // "" means unassigned

      if (!uid) {
        assignMsg.textContent = "Please select a Scout.";
        assignMsg.classList.add("bad");
        return;
      }

      try {
        await updateDoc(doc(db, "accountInfo", uid), {
          patrol: patrolName
        });

        assignMsg.textContent = patrolName ? `Assigned to ${patrolName}.` : "Set to Unassigned.";
        assignMsg.classList.add("ok");
      } catch (err) {
        console.error(err);
        assignMsg.textContent = err?.message || "Error assigning Scout.";
        assignMsg.classList.add("bad");
      }
    }

    // --- Live listeners ---
    function startListeners() {
      // Patrols
      const patrolsQ = query(collection(db, "patrols"), orderBy("name", "asc"));
      onSnapshot(patrolsQ, (snap) => {
        patrols = [];
        snap.forEach(d => {
          const data = d.data() || {};
          patrols.push({
            id: d.id,
            name: data.name || "",
            tags: Array.isArray(data.tags) ? data.tags : []
          });
        });
        renderPatrols();
      });

      // AccountInfo (Scouts)
      // NOTE: This reads the whole collection; for most troops it's fine.
      // If it grows huge later, we can optimize with a "scouts" collection or filters.
      const scoutsQ = query(collection(db, "accountInfo"), orderBy("fullName", "asc"));
      onSnapshot(scoutsQ, (snap) => {
        const list = [];
        snap.forEach(d => {
          const data = d.data() || {};
          const roleType = (data.roleType || "").toString().trim().toLowerCase();      // "Scout" etc
          const acctType = (data.accountType || "").toString().trim().toLowerCase();  // "scout" etc

          const isScout =
            acctType === "scout" ||
            roleType === "scout";

          if (!isScout) return;

          list.push({
            uid: d.id,
            fullName: data.fullName || "",
            email: data.email || "",
            patrol: (data.patrol || "").toString(),
            accountType: data.accountType || data.roleType || "Scout"
          });
        });
        scouts = list;
        renderPatrols();
      });
    }

    // --- Auth ---
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.replace("/");
        return;
      }

      currentUser = user;
      authInfoEl.textContent = `Signed in as ${user.email || user.uid}`;

      const role = await getMyRole(user.uid);
      if (!guardOrRedirect(user, role)) return;

      currentIsAdmin = role === "admin";
      setRoleUI(role);
      showAdminOnly();

      if (currentIsAdmin) {
        createForm.addEventListener("submit", createPatrol);
        assignBtn.addEventListener("click", assignScout);
      }

      startListeners();
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.replace("/");
    });
  </script>
</body>
</html>
