<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Patrols ‚Äî Troop 248</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/bsafavicon.ico">

  <style>
    :root {
      --red: #b22222;
      --blue: #1f4e79;
      --tan: #f4eee3;
      --white: #ffffff;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --radius-lg: 16px;
      --radius-pill: 999px;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.06);
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #d2cab6;
      color: var(--text-main);
      min-height: 100vh;
    }

    header {
      background: linear-gradient(120deg, #b22222, #ffffff, #1f4e79);
      color: var(--white);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
      gap: 10px;
      flex-wrap: wrap;
    }

    header h2 {
      margin: 0;
      font-size: 19px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header h2::before { content: "‚òÖ"; font-size: 18px; }

    .troop-home-link {
      text-decoration: none;
      color: inherit;
      display: inline-flex;
      align-items: center;
    }
    .troop-home-link:hover h2 { opacity: 0.9; text-decoration: underline; }

    nav {
      display: flex;
      gap: 12px;
      font-size: 13px;
      text-transform: uppercase;
      flex-wrap: wrap;
    }
    nav a {
      color: #1f4e79;
      font-weight: bold;
      text-decoration: none;
      padding: 6px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(4px);
      opacity: 0.9;
    }
    nav a:hover { opacity: 1; background: rgba(255, 255, 255, 0.12); }

    #auth-bar {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 13px;
    }
    #logout-btn {
      padding: 5px 12px;
      font-size: 13px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.7);
      background: rgba(255, 255, 255, 0.1);
      color: var(--white);
      cursor: pointer;
    }
    #logout-btn:hover { background: rgba(255, 255, 255, 0.2); }

    main { padding: 24px 16px 40px; max-width: 980px; margin: 0 auto; }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--radius-lg);
      padding: 18px;
      margin-bottom: 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .muted { color: var(--text-muted); }
    .small { font-size: 13px; }

    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: var(--radius-pill);
      background: rgba(148, 163, 184, 0.2);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.07em;
      font-weight: 800;
    }
    .badge.admin {
      background: rgba(240, 180, 41, 0.16);
      color: #92400e;
      border: 1px solid rgba(245, 158, 11, 0.6);
    }

    .hr { height:1px; background: rgba(0,0,0,.08); margin: 12px 0; }

    .admin-only { display: none; }

    /* Create patrol form */
    form {
      margin-top: 10px;
      padding: 10px 10px 8px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px dashed rgba(148, 163, 184, 0.8);
    }
    form h3 { margin: 0 0 8px; font-size: 15px; color: var(--blue); }
    .field { margin-bottom: 8px; }
    .field label {
      display:block;
      font-size: 12px;
      margin-bottom: 3px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .05em;
      font-weight: 800;
    }
    .field input {
      width: 100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-size: 14px;
    }
    .field input:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 2px rgba(31,78,121,.1);
    }
    .btn {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: var(--radius-pill);
      border: none;
      cursor: pointer;
      font-weight: 800;
      background: var(--blue);
      color: #fff;
    }
    .btn:hover { opacity: .96; }

    /* Patrol cards */
    .patrols-wrap { display: flex; flex-direction: column; gap: 12px; }

    .patrol-card {
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(209,213,219,.9);
      background: #f9fafb;
      box-shadow: 0 4px 12px rgba(0,0,0,.04);
    }

    .patrol-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      cursor: pointer;
      user-select: none;
    }

    .patrol-left {
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 220px;
    }

    .patrol-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(209,213,219,.9);
      background: #fff;
      overflow: hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      color: var(--text-muted);
      flex: 0 0 auto;
    }
    .patrol-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }

    .patrol-title { font-weight: 900; font-size: 16px; }
    .patrol-tag {
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      font-weight: 900;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .07em;
      background: rgba(31,78,121,.08);
      color: var(--blue);
      border: 1px solid rgba(31,78,121,.18);
      white-space: nowrap;
    }

    .caret { font-weight: 900; color: var(--text-muted); }

    .patrol-body {
      margin-top: 10px;
      display:none;
    }
    .patrol-body.open { display:block; }

    .dropzone {
      border: 1px dashed rgba(148, 163, 184, 0.9);
      border-radius: 14px;
      background: rgba(255,255,255,.75);
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .dropzone.dragover {
      border-color: rgba(31,78,121,.9);
      box-shadow: 0 0 0 2px rgba(31,78,121,.12);
    }

    .upload-note { font-size: 13px; color: var(--text-muted); font-weight: 700; }
    .upload-actions { display:flex; gap: 8px; flex-wrap: wrap; }

    .btn-soft {
      padding: 8px 12px;
      font-size: 13px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(209,213,219,.9);
      background: rgba(255,255,255,.75);
      color: var(--text-main);
      cursor: pointer;
      font-weight: 900;
    }
    .btn-soft:hover { background: rgba(255,255,255,.95); }

    .scouts {
      margin-top: 10px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      min-height: 20px;
    }

    .scout {
      border-radius: 14px;
      padding: 10px 10px;
      border: 1px solid rgba(209,213,219,.9);
      background: #fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      cursor: grab;
    }
    .scout:active { cursor: grabbing; }

    .scout-name { font-weight: 900; font-size: 14px; }
    .scout-meta { font-size: 12px; color: var(--text-muted); font-weight: 700; }

    .hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .error {
      border: 1px solid rgba(178,34,34,.25);
      background: rgba(178,34,34,.08);
      color: #7f1d1d;
      font-weight: 800;
    }

    @media (max-width: 640px) {
      header { flex-direction: column; align-items: flex-start; }
      .patrol-left { min-width: auto; }
    }
  </style>
</head>

<body>
  <header>
    <div>
      <a href="/home" class="troop-home-link">
        <h2>Troop 248</h2>
      </a>
    </div>

    <nav>
      <a href="/home">Home</a>
      <a href="/calendar">Calendar</a>
      <a href="/documents">Documents</a>
      <a href="/events">Events</a>
      <a href="/roster">Roster</a>
      <a href="/patrols">Patrols</a>
    </nav>

    <div id="auth-bar">
      <div id="auth-info">Signed in as ‚Ä¶</div>
      <button id="logout-btn" type="button">Log Out</button>
    </div>
  </header>

  <main>
    <div class="card">
      <div class="row">
        <div>
          <div style="font-weight:900; font-size:18px;">Patrols</div>
          <div class="muted small" id="roleLine">Checking access‚Ä¶</div>
        </div>
        <div id="roleBadge" class="badge">Loading</div>
      </div>

      <div class="admin-only" id="adminCreateWrap">
        <div class="hr"></div>
        <form id="createForm">
          <h3>Create Patrol</h3>
          <div class="field">
            <label for="patrolName">Patrol Name</label>
            <input id="patrolName" type="text" placeholder="Falcon Patrol" required />
          </div>
          <div class="field">
            <label for="patrolTag">Tag (short label)</label>
            <input id="patrolTag" type="text" placeholder="Falcons" />
          </div>
          <button class="btn" type="submit">Create Patrol</button>
          <div id="createMsg" class="hint"></div>
        </form>
      </div>

      <div class="hint" id="dragHint" style="display:none;">
        Admin tip: drag a Scout card into another patrol (or Unassigned) to move them.
      </div>
    </div>

    <div id="errorCard" class="card error" style="display:none;"></div>

    <div class="patrols-wrap" id="patrolsWrap"></div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, getDocs, setDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD5qUHa2JuQ3iI7U3DrX7JDyhx76PGzhxM",
      authDomain: "troop-248.firebaseapp.com",
      projectId: "troop-248",
      storageBucket: "troop-248.firebasestorage.app",
      messagingSenderId: "925363875752",
      appId: "1:925363875752:web:0b001c1a7a09fb8232f79d",
      measurementId: "G-NY75GX5TBH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const authInfoEl = document.getElementById("auth-info");
    const logoutBtn = document.getElementById("logout-btn");

    const roleLine = document.getElementById("roleLine");
    const roleBadge = document.getElementById("roleBadge");
    const adminCreateWrap = document.getElementById("adminCreateWrap");
    const dragHint = document.getElementById("dragHint");

    const errorCard = document.getElementById("errorCard");
    const patrolsWrap = document.getElementById("patrolsWrap");

    const createForm = document.getElementById("createForm");
    const patrolNameInput = document.getElementById("patrolName");
    const patrolTagInput = document.getElementById("patrolTag");
    const createMsg = document.getElementById("createMsg");

    let currentUser = null;
    let currentRole = "pending"; // admin | viewer | pending
    let isAdmin = false;

    // ---- Helpers ----
    function showError(msg){
      errorCard.style.display = "block";
      errorCard.textContent = msg;
    }

    function normalizeRole(r){
      const x = String(r || "").trim().toLowerCase();
      if (x === "admin") return "admin";
      if (x === "viewer") return "viewer";
      return "pending";
    }

    function setRoleUI(role){
      if (role === "admin") {
        roleLine.textContent = "Approved: Admin (full access)";
        roleBadge.textContent = "Admin";
        roleBadge.className = "badge admin";
      } else if (role === "viewer") {
        roleLine.textContent = "Approved: Viewer (read-only)";
        roleBadge.textContent = "Viewer";
        roleBadge.className = "badge";
      } else {
        roleLine.textContent = "Pending approval";
        roleBadge.textContent = "Pending";
        roleBadge.className = "badge";
      }
    }

    function slugify(text){
      return String(text || "")
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
    }

    function patrolSortKey(name){
      const n = String(name || "").trim();
      if (!n || n.toLowerCase() === "unassigned") return { un: 1, v: "zzzz" };
      return { un: 0, v: n.toLowerCase() };
    }

    function isUnassigned(name){
      const n = String(name || "").trim().toLowerCase();
      return !n || n === "unassigned";
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ---- Data load ----
    async function getMyRole(uid){
      const snap = await getDoc(doc(db, "accountInfo", uid));
      if (!snap.exists()) return "pending";
      return normalizeRole((snap.data() || {}).authRole);
    }

    async function loadPatrolDocs(){
      const snap = await getDocs(collection(db, "patrols"));
      const patrols = [];
      snap.forEach(d => {
        const data = d.data() || {};
        patrols.push({
          id: d.id,
          name: data.name || d.id,
          tag: data.tag || "",
          iconUrl: data.iconUrl || ""
        });
      });
      return patrols;
    }

    async function loadScouts(){
      const snap = await getDocs(collection(db, "accountInfo"));
      const scouts = [];
      snap.forEach(d => {
        const data = d.data() || {};
        if ((data.accountType || "").toLowerCase() !== "scout") return;
        scouts.push({
          uid: d.id,
          fullName: data.fullName || "Unnamed Scout",
          email: data.email || "",
          patrol: data.patrol || ""
        });
      });
      scouts.sort((a,b)=> (a.fullName || "").localeCompare(b.fullName || ""));
      return scouts;
    }

    // ---- Rendering ----
    function makeScoutCard(s){
      const el = document.createElement("div");
      el.className = "scout";
      el.setAttribute("data-uid", s.uid);
      el.setAttribute("draggable", isAdmin ? "true" : "false");
      el.innerHTML = `
        <div>
          <div class="scout-name">${escapeHtml(s.fullName)}</div>
          <div class="scout-meta">${escapeHtml(s.email || "")}</div>
        </div>
        <div class="scout-meta">${escapeHtml(s.uid)}</div>
      `;

      if (isAdmin) {
        el.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", s.uid);
          e.dataTransfer.effectAllowed = "move";
        });
      }

      return el;
    }

    function makePatrolCard(patrolName, patrolDoc, scouts){
      const wrapper = document.createElement("div");
      wrapper.className = "patrol-card";
      wrapper.setAttribute("data-patrol", patrolName);

      const tagText = patrolDoc?.tag || (isUnassigned(patrolName) ? "Unassigned" : "");
      const iconUrl = patrolDoc?.iconUrl || "";

      wrapper.innerHTML = `
        <div class="patrol-head" role="button" tabindex="0" aria-label="Toggle patrol">
          <div class="patrol-left">
            <div class="patrol-icon" id="icon-${escapeHtml(patrolName)}">
              ${iconUrl ? `<img src="${escapeHtml(iconUrl)}" alt="Patrol icon">` : (isUnassigned(patrolName) ? "‚Äî" : "üèïÔ∏è")}
            </div>
            <div>
              <div class="patrol-title">${escapeHtml(patrolName)}</div>
              ${tagText ? `<div class="patrol-tag">${escapeHtml(tagText)}</div>` : `<div class="muted small">No tag</div>`}
            </div>
          </div>
          <div class="caret">‚ñæ</div>
        </div>

        <div class="patrol-body">
          <div class="dropzone ${isAdmin ? "" : "muted"}" data-drop-patrol="${escapeHtml(patrolName)}">
            <div class="upload-note">
              ${isAdmin
                ? `Drop a Scout here to move them ‚Ä¢ Patrol icon: drag image here or click upload`
                : `View-only`}
            </div>

            <div class="upload-actions admin-only">
              <input type="file" accept="image/*" style="display:none" id="file-${escapeHtml(patrolName)}" />
              <button class="btn-soft" type="button" data-upload-btn="${escapeHtml(patrolName)}">Upload Icon</button>
            </div>
          </div>

          <div class="scouts" data-scouts-list="${escapeHtml(patrolName)}"></div>
          <div class="hint">${scouts.length ? "" : "No scouts in this patrol."}</div>
        </div>
      `;

      // Toggle open/close
      const head = wrapper.querySelector(".patrol-head");
      const body = wrapper.querySelector(".patrol-body");
      head.addEventListener("click", () => body.classList.toggle("open"));
      head.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") body.classList.toggle("open");
      });

      // Fill scouts
      const list = wrapper.querySelector(`[data-scouts-list="${CSS.escape(patrolName)}"]`);
      scouts.forEach(s => list.appendChild(makeScoutCard(s)));

      // Admin-only UI
      if (isAdmin) {
        wrapper.querySelectorAll(".admin-only").forEach(el => el.style.display = "inline-flex");

        // Dropzone: move scout between patrols
        const dz = wrapper.querySelector(".dropzone");
        dz.addEventListener("dragover", (e) => {
          e.preventDefault();
          dz.classList.add("dragover");
          e.dataTransfer.dropEffect = "move";
        });
        dz.addEventListener("dragleave", () => dz.classList.remove("dragover"));
        dz.addEventListener("drop", async (e) => {
          e.preventDefault();
          dz.classList.remove("dragover");

          const uid = e.dataTransfer.getData("text/plain");
          if (!uid) return;

          const newPatrol = isUnassigned(patrolName) ? "" : patrolName;

          try {
            await updateDoc(doc(db, "accountInfo", uid), { patrol: newPatrol });
            await refresh();
          } catch (err) {
            showError("Could not move scout: " + (err?.message || String(err)));
          }
        });

        // Patrol icon upload (click OR drag-drop image)
        const fileInput = wrapper.querySelector(`#file-${CSS.escape(patrolName)}`);
        const uploadBtn = wrapper.querySelector(`[data-upload-btn="${CSS.escape(patrolName)}"]`);

        function allowIconUploadHere(){
          return !isUnassigned(patrolName); // don't upload icons for Unassigned
        }

        async function uploadIcon(file){
          if (!allowIconUploadHere()) return;
          if (!file) return;
          if (!file.type.startsWith("image/")) {
            showError("Please upload an image file.");
            return;
          }

          try {
            // Ensure patrol doc exists
            const pid = patrolDoc?.id || slugify(patrolName);
            const patrolRef = doc(db, "patrols", pid);

            // Storage path (one icon per patrol)
            const ext = (file.name.split(".").pop() || "png").toLowerCase();
            const path = `patrol-icons/${pid}.${ext}`;
            const storageRef = sRef(storage, path);

            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);

            // Save on patrol doc
            await setDoc(patrolRef, {
              name: patrolName,
              tag: patrolDoc?.tag || "",
              iconUrl: url
            }, { merge: true });

            await refresh();
          } catch (err) {
            showError("Icon upload failed: " + (err?.message || String(err)));
          }
        }

        uploadBtn.addEventListener("click", () => {
          if (!allowIconUploadHere()) return;
          fileInput.click();
        });

        fileInput.addEventListener("change", async () => {
          const file = fileInput.files?.[0];
          await uploadIcon(file);
          fileInput.value = "";
        });

        // Drag-drop image onto dropzone to upload icon
        dz.addEventListener("drop", async (e) => {
          // If they dropped a file (icon), not a scout uid
          const files = e.dataTransfer.files;
          if (files && files.length && allowIconUploadHere()) {
            // If a scout uid was also present, scout-move handled above; icon upload should be explicit.
            // We'll only upload if there's no uid.
            const uid = e.dataTransfer.getData("text/plain");
            if (!uid) {
              await uploadIcon(files[0]);
            }
          }
        });
      } else {
        // hide upload button in viewer mode
        wrapper.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");
      }

      return wrapper;
    }

    async function render(patrolDocs, scouts){
      patrolsWrap.innerHTML = "";

      // Build a lookup by patrol name (from docs)
      const docByName = new Map();
      patrolDocs.forEach(p => docByName.set((p.name || p.id || "").trim(), p));

      // Group scouts by patrol name (blank => Unassigned)
      const groups = new Map();
      function addToGroup(patrolName, scout){
        const key = isUnassigned(patrolName) ? "Unassigned" : patrolName.trim();
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(scout);
      }

      scouts.forEach(s => addToGroup(s.patrol, s));

      // Ensure we show all patrol docs even if empty
      patrolDocs.forEach(p => {
        const name = (p.name || p.id || "").trim();
        if (!name) return;
        if (!groups.has(name)) groups.set(name, []);
      });

      // Always ensure Unassigned exists
      if (!groups.has("Unassigned")) groups.set("Unassigned", []);

      // Sort: all patrols A-Z, Unassigned last
      const names = Array.from(groups.keys()).sort((a,b)=>{
        const A = patrolSortKey(a);
        const B = patrolSortKey(b);
        if (A.un !== B.un) return A.un - B.un;
        return A.v.localeCompare(B.v);
      });

      names.forEach(name => {
        const docMatch = docByName.get(name) || null;
        const list = groups.get(name) || [];
        patrolsWrap.appendChild(makePatrolCard(name, docMatch, list));
      });
    }

    // ---- Actions ----
    async function refresh(){
      try {
        errorCard.style.display = "none";
        const [patrolDocs, scouts] = await Promise.all([loadPatrolDocs(), loadScouts()]);
        await render(patrolDocs, scouts);
      } catch (err) {
        showError("Error loading patrols: " + (err?.message || String(err)));
      }
    }

    async function createPatrol(e){
      e.preventDefault();
      createMsg.textContent = "";

      const name = (patrolNameInput.value || "").trim();
      const tag = (patrolTagInput.value || "").trim();

      if (!name) {
        createMsg.textContent = "Patrol name required.";
        return;
      }

      const id = slugify(name);
      if (!id) {
        createMsg.textContent = "Could not create an ID from that name.";
        return;
      }

      try {
        await setDoc(doc(db, "patrols", id), {
          name,
          tag,
          iconUrl: ""
        }, { merge: true });

        patrolNameInput.value = "";
        patrolTagInput.value = "";
        createMsg.textContent = "Patrol created.";
        await refresh();
      } catch (err) {
        createMsg.textContent = "Create failed: " + (err?.message || String(err));
      }
    }

    // ---- Auth + boot ----
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.replace("/");
    });

    onAuthStateChanged(auth, async (user) => {
      try {
        if (!user) {
          window.location.replace("/");
          return;
        }
        currentUser = user;
        authInfoEl.textContent = `Signed in as ${user.email || user.uid}`;

        currentRole = await getMyRole(user.uid);
        isAdmin = currentRole === "admin";
        setRoleUI(currentRole);

        if (currentRole !== "admin" && currentRole !== "viewer") {
          window.location.replace("/under-review/");
          return;
        }

        // Admin-only blocks
        if (isAdmin) {
          adminCreateWrap.style.display = "block";
          dragHint.style.display = "block";
          createForm.addEventListener("submit", createPatrol);
        } else {
          adminCreateWrap.style.display = "none";
          dragHint.style.display = "none";
        }

        await refresh();
      } catch (err) {
        showError("Error initializing: " + (err?.message || String(err)));
      }
    });
  </script>
</body>
</html>
