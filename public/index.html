<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Troop 248</title>

  <link rel="stylesheet" href="/styles.css" />

  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    .wrap { padding: 24px; max-width: 1000px; margin: 0 auto; }
    .hidden { display: none; }
    button { padding: 10px 14px; font-size: 16px; cursor: pointer; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Welcome to Troop 248</h1>

    <p id="status">Loading…</p>

    <!-- Logged OUT content (your welcome/login page content goes here) -->
    <div id="loggedOut" class="hidden">
      <p>You are not logged in.</p>
      <p><a href="/login/">Go to Login</a></p>
      <!-- If your login form is on this page, keep it here instead. -->
    </div>

    <!-- Logged IN content (optional; we usually redirect to /home/) -->
    <div id="loggedIn" class="hidden">
      <p>You are logged in. Taking you to the home page…</p>
      <p><a href="/home/">Continue to Home</a></p>
      <button id="logoutBtn">Log out</button>
    </div>
  </div>

  <script type="module">
    // ===== Safe redirect helper (prevents loops) =====
    const params = new URLSearchParams(window.location.search);
    const NO_REDIRECT = params.has("noredirect");

    const redirectOnce = (url) => {
      if (NO_REDIRECT) return;

      const current = (window.location.pathname.replace(/\/+$/, "") || "/");
      const targetPath = (new URL(url, window.location.origin).pathname.replace(/\/+$/, "") || "/");
      if (current === targetPath) return;

      const KEY = "__redirected_to__";
      const last = sessionStorage.getItem(KEY);
      if (last === targetPath) return;

      sessionStorage.setItem(KEY, targetPath);
      window.location.replace(url);
    };

    // ===== Firebase =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // PASTE your real config here (same as you used on /home/)
    const firebaseConfig = {
      apiKey: "PASTE_YOURS",
      authDomain: "PASTE_YOURS",
      projectId: "PASTE_YOURS",
      storageBucket: "PASTE_YOURS",
      messagingSenderId: "PASTE_YOURS",
      appId: "PASTE_YOURS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const statusEl = document.getElementById("status");
    const loggedOutEl = document.getElementById("loggedOut");
    const loggedInEl = document.getElementById("loggedIn");
    const logoutBtn = document.getElementById("logoutBtn");

    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
          sessionStorage.removeItem("__redirected_to__");
          // After logout, stay on welcome page (this page)
          redirectOnce("/");
        } catch (e) {
          console.error(e);
          alert("Logout failed. Please try again.");
        }
      });
    }

    onAuthStateChanged(auth, (user) => {
      statusEl.textContent = "";
      sessionStorage.removeItem("__redirected_to__"); // allow clean navigation decisions

      if (user) {
        loggedInEl.classList.remove("hidden");
        loggedOutEl.classList.add("hidden");
        // Logged in users go to the real home page
        redirectOnce("/home/");
      } else {
        loggedOutEl.classList.remove("hidden");
        loggedInEl.classList.add("hidden");
        // Logged out users stay here. No redirect.
      }
    });
  </script>
</body>
</html>
