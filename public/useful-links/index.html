<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Useful Links — Troop 248</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/bsafavicon.ico" type="image/x-icon">
  <style>
    .troop-home-link {
  text-decoration: none;
  color: inherit;
  display: inline-flex;
  align-items: center;
}

.troop-home-link:hover h2 {
  opacity: 0.9;
  text-decoration: underline;
}
    :root {
      --red: #b22222;
      --blue: #1f4e79;
      --tan: #f4eee3;
      --white: #ffffff;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --radius-lg: 16px;
      --radius-sm: 999px;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.06);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      margin: 0;
      background: #d2cab6;
      color: var(--text-main);
      min-height: 100vh;
    }

    /* ========= FULLSCREEN LOGIN OVERLAY ========= */
    #auth-overlay {
      position: fixed;
      inset: 0;
      display: none; /* shown by JS if NOT logged in */
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #ffffff 0, var(--tan) 70%);
      z-index: 50;
    }

    .auth-card {
      background: rgba(255, 255, 255, 0.96);
      border-radius: 20px;
      padding: 24px 22px 18px;
      width: 100%;
      max-width: 360px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .auth-card-header {
      text-align: center;
      margin-bottom: 16px;
    }

    .auth-card-header h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--blue);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .auth-card-header h1::before {
      content: "★";
      font-size: 18px;
      color: var(--red);
    }

    .auth-card-header p {
      margin: 6px 0 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .auth-fields {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    .auth-fields label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 3px;
    }

    .auth-fields input {
      width: 100%;
      padding: 7px 10px;
      font-size: 14px;
      border-radius: var(--radius-sm);
      border: 1px solid #d1d5db;
      background: #f9fafb;
    }

    .auth-fields input:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 2px rgba(31, 78, 121, 0.18);
    }

    .auth-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .auth-buttons button {
      flex: 1;
      padding: 7px 0;
      font-size: 14px;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      font-weight: 500;
      color: var(--white);
    }

    #login-btn {
      background: var(--blue);
    }

    #signup-btn {
      background: var(--red);
    }

    .auth-note {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
    }

    /* ========= APP SHELL ========= */
    #app-shell {
      display: none; /* shown only when logged in via JS */
      min-height: 100vh;
    }

    header {
      background: linear-gradient(120deg, #b22222, #ffffff, #1f4e79);
      color: var(--white);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h2 {
      margin: 0;
      font-size: 19px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h2::before {
      content: "★";
      font-size: 18px;
    }

    nav {
      display: flex;
      gap: 12px;
      font-size: 13px;
      text-transform: uppercase;
    }

    nav a {
      color: var(--white);
      text-decoration: none;
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(4px);
      opacity: 0.9;
    }

    nav a:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.12);
    }

    #auth-bar {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 13px;
    }

    #auth-info {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #logout-btn {
      padding: 5px 12px;
      font-size: 13px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.7);
      background: rgba(255, 255, 255, 0.1);
      color: var(--white);
      cursor: pointer;
    }

    #logout-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    main {
      padding: 24px 16px 40px;
      max-width: 960px;
      margin: 0 auto;
    }

    .welcome-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--radius-lg);
      padding: 18px 18px 6px;
      margin-bottom: 18px;
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .welcome-card h3 {
      margin: 0 0 4px;
      font-size: 18px;
    }

    .welcome-card p {
      margin: 0;
      font-size: 14px;
      color: var(--text-muted);
    }

    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      background: rgba(148, 163, 184, 0.2);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }

    .badge.admin {
      background: rgba(240, 180, 41, 0.16);
      color: #92400e;
      border: 1px solid rgba(245, 158, 11, 0.6);
    }

    section {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--radius-lg);
      padding: 18px 18px 10px;
      margin-bottom: 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    section h2 {
      margin-top: 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    section h2::before {
      content: "▸";
      font-size: 14px;
      color: var(--blue);
    }

    form {
      margin-bottom: 14px;
      padding: 10px 10px 6px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px dashed rgba(148, 163, 184, 0.8);
    }

    form h3 {
      margin: 0 0 8px;
      font-size: 15px;
      font-weight: 600;
      color: var(--blue);
    }

    .field {
      margin-bottom: 8px;
    }

    .field label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 3px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .field input[type="text"],
.field input[type="url"],
.field textarea,
.field select {
  width: 100%;
  padding: 6px 8px;
  font-size: 14px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  background: #ffffff;
}

    .field textarea {
      resize: vertical;
      min-height: 60px;
    }

    .field input:focus,
    .field textarea:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 2px rgba(31, 78, 121, 0.1);
    }

    form button {
      padding: 6px 14px;
      font-size: 13px;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      font-weight: 500;
      background: var(--blue);
      color: var(--white);
      margin-top: 4px;
    }

    form button:hover {
      opacity: 0.96;
    }

    /* Topic dropdowns */
    .topic-group {
      border-radius: 14px;
      border: 1px solid rgba(209, 213, 219, 0.9);
      margin-bottom: 10px;
      overflow: hidden;
      background: #f9fafb;
    }

    .topic-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.9);
    }

    .topic-title {
      font-size: 14px;
      font-weight: 600;
    }

    .topic-count {
      font-size: 12px;
      color: var(--text-muted);
      margin-left: 6px;
    }

    .topic-toggle {
      font-size: 16px;
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0 4px;
    }

    .topic-links {
      padding: 6px 10px 8px;
      display: none;
    }

    .topic-links.open {
      display: block;
    }

    .item-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-size: 14px;
    }

    .item-list li {
      padding: 6px 0;
      border-bottom: 1px solid rgba(229, 231, 235, 0.9);
    }

    .item-list li:last-child {
      border-bottom: none;
    }

    .item-list strong {
      font-weight: 600;
    }

    .meta {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
      margin-bottom: 2px;
    }

    a.link-anchor {
      color: var(--blue);
      text-decoration: none;
    }

    a.link-anchor:hover {
      text-decoration: underline;
    }

    .small-btn {
      font-size: 11px;
      padding: 2px 8px;
      margin-top: 4px;
      margin-left: 0;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      background: var(--red);
      color: var(--white);
    }

    .small-btn:hover {
      opacity: 0.95;
    }

    .admin-only {
      display: none;
    }

    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      nav {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }
      .welcome-card {
        flex-direction: column;
        align-items: flex-start;
      }
      .auth-card {
        margin: 0 16px;
      }
    }
  </style>
</head>
<body>
  <!-- LOGIN OVERLAY -->
  <div id="auth-overlay">
    <div class="auth-card">
      <div class="auth-card-header">
        <h1>Troop Portal</h1>
        <p>Sign in to view useful links for Troop 248.</p>
      </div>
      <div class="auth-fields">
        <div>
          <label for="email-input">Email</label>
          <input type="email" id="email-input" placeholder="you@example.com" />
        </div>
        <div>
          <label for="password-input">Password</label>
          <input type="password" id="password-input" placeholder="Password" />
        </div>
      </div>
      <div class="auth-buttons">
        <button id="login-btn">Log In</button>
        <button id="signup-btn">Sign Up</button>
      </div>
      <div class="auth-note">
        New accounts are viewers. An adult leader can mark your account as admin.
      </div>
    </div>
  </div>

  <!-- APP SHELL -->
  <div id="app-shell">
    <header>
  <div>
    <a href="/" class="troop-home-link">
      <h2>Troop 248</h2>
    </a>
  </div>
      <nav>
        <a href="/calendar">Calendar</a>
        <a href="/documents">Documents</a>
        <a href="/scoutmaster">Scoutmaster Blog</a>
        <a href="/spl-blog">SPL Blog</a>
        <a href="/useful-links">Useful Links</a>
      </nav>

      <div id="auth-bar">
        <div id="auth-info">Signed in as …</div>
        <button id="logout-btn">Log Out</button>
      </div>
    </header>

    <main>
      <div class="welcome-card">
        <div>
          <h3>Useful Links</h3>
          <p>Curated websites and resources for Troop 248, organized by topic.</p>
        </div>
        <div id="role-badge-container">
          <span class="badge">Viewer</span>
        </div>
      </div>

      <section>
        <h2>Manage Links</h2>

        <form id="links-form" class="admin-only">
          <h3>Add Useful Link</h3>
          <div class="field">
            <label for="link-title">Title</label>
            <input type="text" id="link-title" required />
          </div>
          <div class="field">
            <label for="link-url">URL</label>
            <input type="url" id="link-url" placeholder="https://..." required />
          </div>
          <div class="field">
  <label for="link-topic-select">Topic / Category</label>
  <select id="link-topic-select" required></select>
</div>

<div class="field" id="custom-topic-wrapper" style="display:none;">
  <label for="custom-topic-input">Custom Topic</label>
  <input
    type="text"
    id="custom-topic-input"
    placeholder="Type your topic (e.g. High Adventure)"
  />
</div>
          </div>
          <div class="field">
            <label for="link-description">Description (optional)</label>
            <textarea id="link-description"></textarea>
          </div>
          <button type="submit">Add Link</button>
        </form>
      </section>

      <section>
        <h2>Links by Topic</h2>
        <div id="topics-container">
          <!-- Topics and their dropdowns rendered here -->
        </div>
      </section>
    </main>
  </div>

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    onSnapshot,
    query,
    serverTimestamp,
    doc,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ✅ Troop 248 Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyD5qUHa2JuQ3iI7U3DrX7JDyhx76PGzhxM",
    authDomain: "troop-248.firebaseapp.com",
    projectId: "troop-248",
    storageBucket: "troop-248.firebasestorage.app",
    messagingSenderId: "925363875752",
    appId: "1:925363875752:web:0b001c1a7a09fb8232f79d",
    measurementId: "G-NY75GX5TBH"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Auth elements
  const authOverlay = document.getElementById("auth-overlay");
  const appShell = document.getElementById("app-shell");
  const emailInput = document.getElementById("email-input");
  const passwordInput = document.getElementById("password-input");
  const loginBtn = document.getElementById("login-btn");
  const signupBtn = document.getElementById("signup-btn");
  const logoutBtn = document.getElementById("logout-btn");
  const authInfoEl = document.getElementById("auth-info");
  const roleBadgeContainer = document.getElementById("role-badge-container");
  const adminOnlyEls = document.getElementsByClassName("admin-only");

  // Links elements
  const linksForm = document.getElementById("links-form");
  const linkTitleInput = document.getElementById("link-title");
  const linkUrlInput = document.getElementById("link-url");
  const linkDescInput = document.getElementById("link-description");
  const topicsContainer = document.getElementById("topics-container");
  const topicSelect = document.getElementById("link-topic-select");
  const customTopicWrapper = document.getElementById("custom-topic-wrapper");
  const customTopicInput = document.getElementById("custom-topic-input");

   // You can customize this list of suggested topics:
const TOPIC_OPTIONS = [
  "BSA Organizational Links",
  "Advancement",
  "Merit Badges",
  "Other" // ⚠️ keep "Other" so custom-topic flow works
];

function populateTopicOptions() {
  // Default placeholder option
  topicSelect.innerHTML =
    '<option value="" disabled selected>Select a topic</option>' +
    TOPIC_OPTIONS.map(
      (t) => `<option value="${t}">${t}</option>`
    ).join("");
}

// Show / hide custom topic input based on selection
topicSelect.addEventListener("change", () => {
  if (topicSelect.value === "Other") {
    customTopicWrapper.style.display = "block";
    customTopicInput.focus();
  } else {
    customTopicWrapper.style.display = "none";
    customTopicInput.value = "";
  }
});

// Call this once after the DOM references are ready
populateTopicOptions();

 // Admins
  const ADMIN_UIDS = [
    "l1TlAvSdW0hpZUPU5eA0XBWD2OA3"
  ];

  let currentUser = null;
  let currentIsAdmin = false;

  function updateAdminUI() {
    for (let i = 0; i < adminOnlyEls.length; i++) {
      adminOnlyEls[i].style.display = currentIsAdmin ? "block" : "none";
    }

    if (currentUser) {
      authOverlay.style.display = "none";
      appShell.style.display = "block";
      authInfoEl.textContent = `Signed in as ${currentUser.email}`;
      roleBadgeContainer.innerHTML = `
        <span class="badge ${currentIsAdmin ? "admin" : ""}">
          ${currentIsAdmin ? "Admin" : "Viewer"}
        </span>`;
    } else {
      authOverlay.style.display = "flex";
      appShell.style.display = "none";
    }
  }

  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    currentIsAdmin = !!(user && ADMIN_UIDS.includes(user.uid));
    console.log("Auth state changed. UID:", user?.uid, "isAdmin:", currentIsAdmin);
    updateAdminUI();
  });

  // Login / signup / logout handlers
  loginBtn.addEventListener("click", async () => {
    const email = emailInput.value.trim();
    const pass = passwordInput.value.trim();
    if (!email || !pass) return alert("Please enter email and password");
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      emailInput.value = "";
      passwordInput.value = "";
    } catch (e) {
      console.error("Login error:", e);
      alert("Login failed: " + e.message);
    }
  });

  signupBtn.addEventListener("click", async () => {
    const email = emailInput.value.trim();
    const pass = passwordInput.value.trim();
    if (!email || !pass) return alert("Please enter email and password");
    try {
      await createUserWithEmailAndPassword(auth, email, pass);
      alert("Account created! You are a viewer by default.");
      emailInput.value = "";
      passwordInput.value = "";
    } catch (e) {
      console.error("Signup error:", e);
      alert("Signup failed: " + e.message);
    }
  });

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
  });

linksForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!currentIsAdmin) return alert("Only admins can add links.");

  const title = linkTitleInput.value.trim();
  const url = linkUrlInput.value.trim();
  const selectedTopic = topicSelect.value;
  const description = linkDescInput.value.trim();

  if (!title || !url || !selectedTopic) {
    return alert("Title, URL, and Topic are required.");
  }

  let topic = selectedTopic;

  // If "Other" is selected, require a custom topic
  if (selectedTopic === "Other") {
    const customTopic = customTopicInput.value.trim();
    if (!customTopic) {
      alert("Please enter a custom topic.");
      customTopicInput.focus();
      return;
    }
    topic = customTopic;
  }

  try {
    await addDoc(collection(db, "usefulLinks"), {
      title,
      url,
      topic,
      description,
      createdAt: serverTimestamp()
    });
    console.log("Link added:", { title, url, topic });
    linkTitleInput.value = "";
    linkUrlInput.value = "";
    topicSelect.value = "";
    customTopicWrapper.style.display = "none";
    customTopicInput.value = "";
    linkDescInput.value = "";
  } catch (e) {
    console.error("Error adding link:", e);
    alert("Error adding link: " + e.message);
  }
});

  // Render links grouped by topic, with dropdown and alphabetical sorting
  function renderLinksGrouped(docs) {
    topicsContainer.innerHTML = "";

    if (!docs || docs.length === 0) {
      topicsContainer.innerHTML = '<p class="meta">No links added yet.</p>';
      topicDatalist.innerHTML = "";
      return;
    }

    const groups = {};
    docs.forEach((docSnap) => {
      const data = docSnap.data();
      const topic = (data.topic || "Other").trim() || "Other";
      if (!groups[topic]) {
        groups[topic] = [];
      }
      groups[topic].push({ id: docSnap.id, data });
    });

    // Topics alphabetical
    const topics = Object.keys(groups).sort((a, b) =>
      a.toLowerCase().localeCompare(b.toLowerCase())
    );

    // Update datalist with current topics
    topicDatalist.innerHTML = topics
      .map((t) => `<option value="${t}"></option>`)
      .join("");

    topics.forEach((topic, index) => {
      const links = groups[topic];

      // sort links alphabetically by title
      links.sort((a, b) => {
        const t1 = (a.data.title || "").toLowerCase();
        const t2 = (b.data.title || "").toLowerCase();
        return t1.localeCompare(t2);
      });

      const groupEl = document.createElement("div");
      groupEl.className = "topic-group";

      const headerEl = document.createElement("div");
      headerEl.className = "topic-header";

      const titleEl = document.createElement("div");
      titleEl.className = "topic-title";
      titleEl.textContent = topic;

      const countEl = document.createElement("span");
      countEl.className = "topic-count";
      countEl.textContent = `(${links.length} link${links.length === 1 ? "" : "s"})`;
      titleEl.appendChild(countEl);

      const toggleBtn = document.createElement("button");
      toggleBtn.type = "button";
      toggleBtn.className = "topic-toggle";
      toggleBtn.textContent = index === 0 ? "▴" : "▾"; // first topic open by default

      headerEl.appendChild(titleEl);
      headerEl.appendChild(toggleBtn);

      const linksWrapper = document.createElement("div");
      linksWrapper.className = "topic-links";
      if (index === 0) {
        linksWrapper.classList.add("open");
      }

      const ul = document.createElement("ul");
      ul.className = "item-list";

      links.forEach((linkDoc) => {
        const { id, data } = linkDoc;
        const created = data.createdAt?.toDate
          ? data.createdAt.toDate().toLocaleString()
          : "";

        const li = document.createElement("li");
        li.innerHTML = `
          <strong>
            <a class="link-anchor" href="${data.url}" target="_blank" rel="noopener noreferrer">
              ${data.title || "Untitled"}
            </a>
          </strong>
          <div class="meta">${created}</div>
          <div>${data.description || ""}</div>
        `;

        if (currentIsAdmin) {
          const btn = document.createElement("button");
          btn.textContent = "Delete";
          btn.className = "small-btn";
          btn.onclick = async () => {
            if (confirm("Delete this link?")) {
              await deleteDoc(doc(db, "usefulLinks", id));
            }
          };
          li.appendChild(btn);
        }

        ul.appendChild(li);
      });

      linksWrapper.appendChild(ul);

      // toggle logic
      const toggleFn = () => {
        const isOpen = linksWrapper.classList.contains("open");
        if (isOpen) {
          linksWrapper.classList.remove("open");
          toggleBtn.textContent = "▾";
        } else {
          linksWrapper.classList.add("open");
          toggleBtn.textContent = "▴";
        }
      };

      headerEl.addEventListener("click", toggleFn);
      toggleBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        toggleFn();
      });

      groupEl.appendChild(headerEl);
      groupEl.appendChild(linksWrapper);

      topicsContainer.appendChild(groupEl);
    });
  }

  // Live listener for all useful links (no orderBy; we sort in JS)
  const linksQuery = query(collection(db, "usefulLinks"));

  onSnapshot(linksQuery, (snapshot) => {
    console.log("usefulLinks snapshot size:", snapshot.size);
    renderLinksGrouped(snapshot.docs);
  });
</script>
</body>
</html>

