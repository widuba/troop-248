<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/bsafavicon.ico">
  <title>Troop 248 — Login</title>

  <style>
    :root {
      --red: #b22222;
      --blue: #1f4e79;
      --tan: #d2cab6;
      --card: rgba(255,255,255,.95);
      --muted: #6b7280;
      --radius: 16px;
      --pill: 999px;
      --shadow: 0 10px 25px rgba(0,0,0,.06);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--tan);
      color: #1f2933;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(120deg, #b22222, #ffffff, #1f4e79);
      padding: 14px 24px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header a {
      text-decoration: none;
      color: #fff;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
    }

    main { max-width: 860px; margin: 0 auto; padding: 24px 16px 40px; }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid rgba(148,163,184,.4);
      box-shadow: var(--shadow);
      padding: 18px;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 720px) { .row { grid-template-columns: 1fr; } }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .tab {
      border: 1px solid rgba(31,78,121,.25);
      background: rgba(31,78,121,.06);
      color: var(--blue);
      padding: 8px 12px;
      border-radius: var(--pill);
      font-weight: 800;
      cursor: pointer;
    }
    .tab.active {
      background: rgba(31,78,121,.14);
      border-color: rgba(31,78,121,.45);
    }

    label { display: block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(209,213,219,.9);
      font-size: 15px;
      background: #fff;
    }
    textarea { min-height: 92px; resize: vertical; }

    .btn {
      margin-top: 14px;
      width: 100%;
      padding: 11px 14px;
      border-radius: 14px;
      border: 1px solid rgba(31,78,121,.25);
      background: rgba(31,78,121,.10);
      color: var(--blue);
      font-weight: 900;
      cursor: pointer;
      font-size: 16px;
    }
    .btn:hover { background: rgba(31,78,121,.16); }
    .btn.danger {
      border-color: rgba(178,34,34,.35);
      background: rgba(178,34,34,.08);
      color: #7f1d1d;
    }

    .muted { color: var(--muted); font-size: 13px; }
    .msg { margin-top: 10px; font-size: 13px; color: #7f1d1d; }
    .ok { color: #065f46; }
    .hidden { display: none; }

    .smallLinks {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .smallLinks a { color: var(--blue); font-weight: 700; text-decoration: underline; }
  </style>
</head>

<body>
  <header>
    <a href="/">★ Troop 248</a>
  </header>

  <main>
    <div class="card">
      <h2 style="margin:0 0 6px;">Member Sign In</h2>
      <p class="muted" style="margin:0 0 14px;">
        Log in or create an account. New accounts start as <b>Pending</b> until approved.
      </p>

      <div class="tabs">
        <button id="tabLogin" class="tab active" type="button">Log In</button>
        <button id="tabSignup" class="tab" type="button">Sign Up</button>
      </div>

      <p id="status" class="muted">Loading…</p>

      <!-- LOGIN -->
      <div id="loginPanel">
        <label>Email</label>
        <input id="loginEmail" type="email" autocomplete="email" placeholder="you@example.com" />

        <label>Password</label>
        <input id="loginPassword" type="password" autocomplete="current-password" placeholder="••••••••" />

        <button id="loginBtn" class="btn" type="button">Log In</button>

        <button id="resetBtn" class="btn danger" type="button">Forgot Password</button>

        <div id="loginMsg" class="msg"></div>
      </div>

      <!-- SIGNUP -->
      <div id="signupPanel" class="hidden">
        <div class="row">
          <div>
            <label>Full Name</label>
            <input id="fullName" type="text" autocomplete="name" placeholder="First Last" />
          </div>
          <div>
  <label>Username (letters & numbers, up to 15)</label>
  <input id="signupUsername" type="text" maxlength="15" placeholder="e.g. troop248joe" autocomplete="username" />
  <div id="signupUsernameHelp" style="font-size:12px;color:#6b7280;margin-top:6px;">Only letters & numbers. 1–15 chars.</div>
</div>
          <div>
            <label>Account Type</label>
            <select id="accountType">
              <option value="scout">Scout</option>
              <option value="parent">Parent/Guardian</option>
              <option value="leader">Adult Leader</option>
            </select>
          </div>
        </div>
        
        <label>Phone Number</label>
        <input
          id="phone"
          type="tel"
          inputmode="tel"
          autocomplete="tel"
          placeholder="(555) 555-5555"
        />

        <label>Email</label>
        <input id="signupEmail" type="email" autocomplete="email" placeholder="you@example.com" />

        <div class="row">
          <div>
            <label>Password</label>
            <input id="signupPassword" type="password" autocomplete="new-password" placeholder="Create a password" />
          </div>
          <div>
            <label>Confirm Password</label>
            <input id="signupPassword2" type="password" autocomplete="new-password" placeholder="Repeat password" />
          </div>
        </div>

        <label>Notes (optional)</label>
        <textarea id="notes" placeholder="Anything the admins should know (patrol, parent name, etc.)"></textarea>

        <button id="signupBtn" class="btn" type="button">Create Account</button>

        <p class="muted" style="margin:10px 0 0;">
          New accounts are created as <b>Pending</b> and will be redirected to the Under Review page.
        </p>

        <div id="signupMsg" class="msg"></div>
      </div>

      <div class="smallLinks">
        <a href="/">Back to Home</a>
        <a href="/under-review/">Under Review</a>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      sendPasswordResetEmail,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ====== Safety: stop redirect loops + allow bypass ======
    const params = new URLSearchParams(window.location.search);
    const NO_REDIRECT = params.has("noredirect");

    const redirectOnce = (url) => {
      if (NO_REDIRECT) return;

      const current = (window.location.pathname.replace(/\/+$/, "") || "/");
      const target = (new URL(url, window.location.origin).pathname.replace(/\/+$/, "") || "/");
      if (current === target) return;

      const KEY = "__redirected_to__";
      const last = sessionStorage.getItem(KEY);
      if (last === target) return;

      sessionStorage.setItem(KEY, target);
      window.location.replace(url);
    };

    // ====== Your Firebase config ======
    const firebaseConfig = {
      apiKey: "AIzaSyD5qUHa2JuQ3iI7U3DrX7JDyhx76PGzhxM",
      authDomain: "troop-248.firebaseapp.com",
      projectId: "troop-248",
      storageBucket: "troop-248.firebasestorage.app",
      messagingSenderId: "925363875752",
      appId: "1:925363875752:web:0b001c1a7a09fb8232f79d",
      measurementId: "G-NY75GX5TBH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // get element refs
const signupUsername = document.getElementById("signupUsername");
const signupUsernameHelp = document.getElementById("signupUsernameHelp");

// helper: valid username
function validUsername(v){
  if(!v) return false;
  return /^[A-Za-z0-9]{1,15}$/.test(v);
}

signupBtn.addEventListener("click", async () => {
  setMsg(signupMsg, "");
  const email = signupEmail.value.trim();
  const pw1 = signupPassword.value;
  const pw2 = signupPassword2.value;
  const usernameVal = signupUsername.value.trim();

  if (!email) return setMsg(signupMsg, "Please enter an email.");
  if (!pw1 || pw1.length < 6) return setMsg(signupMsg, "Password must be at least 6 characters.");
  if (pw1 !== pw2) return setMsg(signupMsg, "Passwords do not match.");
  if (usernameVal && !validUsername(usernameVal)) return setMsg(signupMsg, "Username must be 1–15 letters and numbers only.");

  signupBtn.disabled = true;

  try {
    // If username entered, check quick uniqueness by querying accountInfo
    if (usernameVal) {
      const q = query(collection(db, "accountInfo"), where("username", "==", usernameVal));
      const snap = await getDocs(q);
      if (!snap.empty) {
        setMsg(signupMsg, "Username already taken. Pick another.");
        signupBtn.disabled = false;
        return;
      }
    }

    sessionStorage.removeItem("__redirected_to__");
    const cred = await createUserWithEmailAndPassword(auth, email, pw1);
    const user = cred.user;

    // create accountInfo doc for the new user
    await setDoc(doc(db, "accountInfo", user.uid), {
      authRole: "pending",
      email: user.email || email,
      fullName: fullName.value.trim() || "",
      accountType: accountType.value,
      notes: notes.value.trim() || "",
      // include username only if provided
      ...(usernameVal ? { username: usernameVal } : {}),
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    }, { merge: true });

    // redirect to under-review
    redirectOnce("/under-review/");
  } catch (e) {
    console.error(e);
    if (e?.code === "auth/email-already-in-use") {
      setMsg(signupMsg, "That email is already in use. Try logging in instead.");
    } else if (e?.code === "auth/invalid-email") {
      setMsg(signupMsg, "That email address doesn't look valid.");
    } else if (e?.code === "auth/weak-password") {
      setMsg(signupMsg, "That password is too weak. Use at least 6 characters.");
    } else {
      setMsg(signupMsg, "Sign up failed. Please try again.");
    }
    try { await signOut(auth); } catch {}
  } finally {
    signupBtn.disabled = false;
  }
});

    // ====== UI helpers ======
    const statusEl = document.getElementById("status");

    const tabLogin = document.getElementById("tabLogin");
    const tabSignup = document.getElementById("tabSignup");
    const loginPanel = document.getElementById("loginPanel");
    const signupPanel = document.getElementById("signupPanel");

    const loginEmail = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");
    const loginBtn = document.getElementById("loginBtn");
    const resetBtn = document.getElementById("resetBtn");
    const loginMsg = document.getElementById("loginMsg");

    const fullName = document.getElementById("fullName");
    const accountType = document.getElementById("accountType");
    const phone = document.getElementById("phone"); // ✅ NEW
    const signupEmail = document.getElementById("signupEmail");
    const signupPassword = document.getElementById("signupPassword");
    const signupPassword2 = document.getElementById("signupPassword2");
    const notes = document.getElementById("notes");
    const signupBtn = document.getElementById("signupBtn");
    const signupMsg = document.getElementById("signupMsg");

    const setMsg = (el, text, ok=false) => {
      el.textContent = text || "";
      el.classList.toggle("ok", !!ok);
    };

    const showLogin = () => {
      tabLogin.classList.add("active");
      tabSignup.classList.remove("active");
      loginPanel.classList.remove("hidden");
      signupPanel.classList.add("hidden");
      setMsg(loginMsg, "");
      setMsg(signupMsg, "");
    };

    const showSignup = () => {
      tabSignup.classList.add("active");
      tabLogin.classList.remove("active");
      signupPanel.classList.remove("hidden");
      loginPanel.classList.add("hidden");
      setMsg(loginMsg, "");
      setMsg(signupMsg, "");
    };

    tabLogin.addEventListener("click", showLogin);
    tabSignup.addEventListener("click", showSignup);

    // ====== Role gate: admin/viewer => home, pending/anything else => under-review ======
    async function routeByRole(user) {
      // No user: stay on /login/
      if (!user) return;

      // If user doc missing, treat as under review
      const infoRef = doc(db, "accountInfo", user.uid);
      const snap = await getDoc(infoRef);

      if (!snap.exists()) {
        redirectOnce("/under-review/");
        return;
      }

      const data = snap.data() || {};
      const role = data.authRole;

      if (role === "admin" || role === "viewer") {
        redirectOnce("/home/");
        return;
      }

      // pending or anything unexpected
      redirectOnce("/under-review/");
    }

    // ====== Login ======
    loginBtn.addEventListener("click", async () => {
      setMsg(loginMsg, "");
      loginBtn.disabled = true;

      try {
        sessionStorage.removeItem("__redirected_to__");
        await signInWithEmailAndPassword(auth, loginEmail.value.trim(), loginPassword.value);
        // onAuthStateChanged will route
      } catch (e) {
        console.error(e);
        setMsg(loginMsg, "Login failed. Check your email/password and try again.");
      } finally {
        loginBtn.disabled = false;
      }
    });

    // ====== Password reset ======
    resetBtn.addEventListener("click", async () => {
      setMsg(loginMsg, "");
      const addr = loginEmail.value.trim();
      if (!addr) return setMsg(loginMsg, "Enter your email first, then click Forgot Password.");

      resetBtn.disabled = true;
      try {
        await sendPasswordResetEmail(auth, addr);
        setMsg(loginMsg, "Password reset email sent.", true);
      } catch (e) {
        console.error(e);
        setMsg(loginMsg, "Could not send reset email. Try again.");
      } finally {
        resetBtn.disabled = false;
      }
    });

    // ====== Sign up ======
    signupBtn.addEventListener("click", async () => {
      setMsg(signupMsg, "");
      const email = signupEmail.value.trim();
      const pw1 = signupPassword.value;
      const pw2 = signupPassword2.value;

      if (!email) return setMsg(signupMsg, "Please enter an email.");
      if (!pw1 || pw1.length < 6) return setMsg(signupMsg, "Password must be at least 6 characters.");
      if (pw1 !== pw2) return setMsg(signupMsg, "Passwords do not match.");

      // ✅ Phone is optional, but stored if provided
      const phoneRaw = (phone?.value || "").trim();

      signupBtn.disabled = true;

      try {
        sessionStorage.removeItem("__redirected_to__");

        const cred = await createUserWithEmailAndPassword(auth, email, pw1);
        const user = cred.user;

        await setDoc(doc(db, "accountInfo", user.uid), {
          authRole: "pending",
          email: user.email || email,
          fullName: fullName.value.trim() || "",
          accountType: accountType.value,
          phone: phoneRaw || "",              // ✅ NEW
          notes: notes.value.trim() || "",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });

        redirectOnce("/under-review/");
      } catch (e) {
        console.error(e);

        if (e?.code === "auth/email-already-in-use") {
          setMsg(signupMsg, "That email is already in use. Try logging in instead.");
        } else if (e?.code === "auth/invalid-email") {
          setMsg(signupMsg, "That email address doesn't look valid.");
        } else if (e?.code === "auth/weak-password") {
          setMsg(signupMsg, "That password is too weak. Use at least 6 characters.");
        } else {
          setMsg(signupMsg, "Sign up failed. Please try again.");
        }

        try { await signOut(auth); } catch {}
      } finally {
        signupBtn.disabled = false;
      }
    });

    // ====== If already signed in, route immediately ======
    onAuthStateChanged(auth, async (user) => {
      statusEl.textContent = "";
      await routeByRole(user);
    });
  </script>
</body>
</html>
